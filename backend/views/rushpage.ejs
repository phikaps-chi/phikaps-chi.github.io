<script>
    // Unified State Manager - combines debouncing with state management
    window.stateManager = {
      debounceTimers: new Map(),
      pendingUpdates: new Map(),
      version: 0,
      pendingOps: new Map(),

      // Debouncing function for rapid UI updates (800ms default for better batching)
      debounceUpdate(recruitId, field, updateFn, delay = 800) {
        const key = `${field}-${recruitId}`;
        console.log(`Debouncing ${field} for recruit ${recruitId}`);

        // Clear existing timer
        if (this.debounceTimers.has(key)) {
          clearTimeout(this.debounceTimers.get(key));
        }

        // Store the latest update
        this.pendingUpdates.set(key, updateFn);

        // Set new timer
        const timer = setTimeout(() => {
          console.log(`Executing debounced ${field} for recruit ${recruitId}`);
          const pendingUpdate = this.pendingUpdates.get(key);
          if (pendingUpdate) {
            pendingUpdate();
            this.pendingUpdates.delete(key);
          }
          this.debounceTimers.delete(key);
        }, delay);

        this.debounceTimers.set(key, timer);
      },

      clearOperation(recruitId, field) {
        const key = `${field}-${recruitId}`;
        if (this.debounceTimers.has(key)) {
          clearTimeout(this.debounceTimers.get(key));
          this.debounceTimers.delete(key);
        }
        this.pendingUpdates.delete(key);
        // Also clear from pendingOps if exists
        const opKey = `${recruitId}-${field}`;
        this.pendingOps.delete(opKey);
      },

      trackOperation(recruitId, field, value, version) {
        const key = `${recruitId}-${field}`;
        this.pendingOps.set(key, {
          recruitId,
          field,
          value,
          version,
          timestamp: Date.now()
        });
      },

      getPendingValue(recruitId, field) {
        const key = `${recruitId}-${field}`;
        return this.pendingOps.get(key);
      },

      localState: {
        members: new Map(),
        scrollPosition: 0,
        focusedElement: null,
        formData: {},
        commentDrafts: new Map(),
        preserveScroll: false,
        globalDisableAddRecruits: false, // New: Global disable for adding recruits
        globalDisableCommenting: false,  // New: Global disable for commenting
        // New: Stores per-brother disable settings, keyed by brother's email/ID
        disabledBrotherSettings: {} // { 'email@example.com': { commenting: true, interactions: false } }
      },

      // Save state function
      saveState(preserveScroll = true) {
        this.localState.preserveScroll = preserveScroll;

        // Only save scroll if we want to preserve it and user isn't at the very top
        if (preserveScroll && window.scrollY > 10) {
          this.localState.scrollPosition = window.scrollY;
        }

        // Save focused element state
        const activeElement = document.activeElement;
        if (activeElement && activeElement.id &&
            (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
          this.localState.focusedElement = {
            id: activeElement.id,
            value: activeElement.value || '',
            selectionStart: activeElement.selectionStart || 0,
            selectionEnd: activeElement.selectionEnd || 0
          };
        } else {
          this.localState.focusedElement = null;
        }
      },

      // Restore state function
      restoreState() {
        // Restore focused element first (synchronously)
        if (this.localState.focusedElement) {
          const element = document.getElementById(this.localState.focusedElement.id);
          if (element) {
            try {
              element.focus();
              if (this.localState.focusedElement.value && element.value !== this.localState.focusedElement.value) {
                element.value = this.localState.focusedElement.value;
              }
              if (element.setSelectionRange &&
                  typeof this.localState.focusedElement.selectionStart === 'number') {
                element.setSelectionRange(
                  this.localState.focusedElement.selectionStart,
                  this.localState.focusedElement.selectionEnd
                );
              }
            } catch (e) {
              console.warn('Error restoring focus:', e);
            }
          }
        }

        // Restore scroll position (asynchronously, only if preserved)
        if (this.localState.preserveScroll && this.localState.scrollPosition > 10) {
          // Use multiple strategies to ensure scroll restoration works
          const targetScroll = this.localState.scrollPosition;

          // Immediate scroll attempt
          window.scrollTo(0, targetScroll);

          // Backup with requestAnimationFrame
          requestAnimationFrame(() => {
            if (Math.abs(window.scrollY - targetScroll) > 50) {
              window.scrollTo(0, targetScroll);
            }
          });

          // Final backup with setTimeout
          setTimeout(() => {
            if (Math.abs(window.scrollY - targetScroll) > 50) {
              window.scrollTo(0, targetScroll);
            }
          }, 100);
        }
      },

      // Cleanup old pending operations
      cleanupOldOperations() {
        const now = Date.now();
        const timeout = 30000;

        for (const [key, op] of this.pendingOps) {
          if (now - op.timestamp > timeout) {
            this.pendingOps.delete(key);
          }
        }
      }
    };

    // Admin functions
    window.stateManager.localState.allBrothers = window.stateManager.localState.allBrothers || [];


    function toggleAdminMenu() {
      const menu = document.getElementById('adminMenu');
      const adminMenuBtn = document.getElementById('adminMenuBtn');
      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        adminMenuBtn.textContent = 'Close Admin';
      } else {
        menu.style.display = 'none';
        adminMenuBtn.textContent = 'Admin';
      }
    }

    async function initAdminMenu() {
      // Show admin button only if current user is Rho
      if (!position.includes("Rho")) {
        document.getElementById('adminMenuBtn').style.display = 'none';
        return;
      } else {
        document.getElementById('adminMenuBtn').style.display = 'inline-block';
      }

      // Populate brother list (assuming 'contacts' is available globally, or fetch from backend)
      const selectBrotherToManage = document.getElementById('selectBrotherToManage');
      selectBrotherToManage.innerHTML = '<option value="">Select a brother...</option>'; // Clear existing options
      
      // Fetch all brothers from backend for the dropdown
      try {
        const res = await fetch('/api/rush/brothers' + window.location.search);
        if (!res.ok) throw new Error('Failed to load brothers');
        window.stateManager.localState.allBrothers = await res.json();
        window.stateManager.localState.allBrothers.forEach(bro => {
          const option = document.createElement('option');
          option.value = bro.email;
          option.textContent = bro.name || bro.email;
          selectBrotherToManage.appendChild(option);
        });
      } catch (error) {
        console.error("Failed to load brothers for admin menu:", error);
        showMessage("Failed to load brothers for admin menu.", 'error');
        if (typeof contacts !== 'undefined' && Array.isArray(contacts)) {
          contacts.forEach(broName => {
            const option = document.createElement('option');
            option.value = broName;
            option.textContent = broName;
            selectBrotherToManage.appendChild(option);
          });
        }
      }

      // Load global settings from backend
      try {
        const res = await fetch('/api/rush/admin-settings' + window.location.search);
        if (!res.ok) throw new Error('Failed to load admin settings');
        const adminSettings = await res.json();
        window.stateManager.localState.globalDisableAddRecruits = adminSettings.globalDisableAddRecruits || false;
        window.stateManager.localState.globalDisableCommenting = adminSettings.globalDisableCommenting || false;
        window.stateManager.localState.disabledBrotherSettings = adminSettings.disabledBrotherSettings || {};

        document.getElementById('globalDisableAddRecruits').checked = window.stateManager.localState.globalDisableAddRecruits;
        document.getElementById('globalDisableCommenting').checked = window.stateManager.localState.globalDisableCommenting;

      } catch (error) {
        console.error("Failed to load admin settings:", error);
        showMessage("Failed to load admin settings.", 'error');
      }
    }

    // Global settings handlers
    function setGlobalAddRecruits(disabled) {
      window.stateManager.localState.globalDisableAddRecruits = disabled;
      fetch('/api/rush/admin-settings/global' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key: 'globalDisableAddRecruits', value: disabled })
      }).then(r => r.json()).catch(onFailure);
    }

    function setGlobalCommenting(disabled) {
      window.stateManager.localState.globalDisableCommenting = disabled;
      fetch('/api/rush/admin-settings/global' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key: 'globalDisableCommenting', value: disabled })
      }).then(r => r.json()).catch(onFailure);
    }

    // Per-brother settings handlers
    function loadBrotherSettings() {
      const selectBrotherToManage = document.getElementById('selectBrotherToManage');
      const brotherSpecificControls = document.getElementById('brotherSpecificControls');
      const selectedBrotherEmail = selectBrotherToManage.value;

      if (selectedBrotherEmail) {
        brotherSpecificControls.style.display = 'block';
        const settings = window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail] || {};
        document.getElementById('disableBrotherCommenting').checked = settings.commenting || false;
        document.getElementById('disableBrotherInteractions').checked = settings.intereractions || false;
      } else {
        brotherSpecificControls.style.display = 'none';
      }
    }

    function setBrotherCommenting(disabled) {
      const selectBrotherToManage = document.getElementById('selectBrotherToManage');
      const selectedBrotherEmail = selectBrotherToManage.value;
      if (!selectedBrotherEmail) return;

      if (!window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail]) {
        window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail] = {};
      }
      window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail].commenting = disabled;
    }

    function setBrotherInteractions(disabled) {
      const selectBrotherToManage = document.getElementById('selectBrotherToManage');
      const selectedBrotherEmail = selectBrotherToManage.value;
      if (!selectedBrotherEmail) return;

      if (!window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail]) {
        window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail] = {};
      }
      window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail].intereractions = disabled;
      throttledRender(); // Re-render to apply interaction disable to current user if they are the selected brother
    }

    function saveBrotherSettings() {
      const selectBrotherToManage = document.getElementById('selectBrotherToManage');
      const selectedBrotherEmail = selectBrotherToManage.value;
      if (!selectedBrotherEmail) {
        showMessage("Please select a brother to save settings for.", 'warning');
        return;
      }
      const settingsToSave = window.stateManager.localState.disabledBrotherSettings[selectedBrotherEmail] || {};
      fetch('/api/rush/admin-settings/brother' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: selectedBrotherEmail, settings: settingsToSave })
      }).then(r => r.json()).catch(onFailure);
      showMessage(`Settings for ${selectedBrotherEmail} saved.`, 'success');
    }

    // Helper to check if current user is disabled for a specific action type
    function isCurrentUserActionDisabled(actionType) {
        const currentUserSettings = window.stateManager.localState.disabledBrotherSettings[currentUserEmail] || {};
        const globalDisableCommenting = window.stateManager.localState.globalDisableCommenting;
        const globalDisableAddRecruits = window.stateManager.localState.globalDisableAddRecruits;

        if (actionType === 'commenting') {
            return globalDisableCommenting || currentUserSettings.commenting;
        }
        if (actionType === 'interactions') { // For met, like, dislike
            return currentUserSettings.intereractions;
        }
        if (actionType === 'addRecruits') {
            return globalDisableAddRecruits;
        }
        return false;
    }



    function getCommentTimestamp(c) {
      if (!c) return null;
      console.log("Timestamp: ", c)
      // Prefer server-provided epoch ms, but accept various shapes
      let v = c.timestampMs ?? c.timestamp ?? c.localTs ?? null;
      if (v == null) return null;
    
      if (v instanceof Date) return v.getTime();
      if (typeof v === 'string') {
        // Try to parse numeric epoch string first
        if (/^\d+$/.test(v)) {
          const num = Number(v);
          return num < 1e12 ? num * 1000 : num;
        }
    
        const parsed = Date.parse(v); // Try ISO or date-like string
        return isNaN(parsed) ? null : parsed;
    }
      // number: allow epoch seconds or ms
      if (typeof v === 'number') return v < 1e12 ? v * 1000 : v;
    
      return null;
    }
    
    function formatCommentTime(ts) {
      //if (!ts) return '';
      console.log("ts: ", ts)
      const d = new Date(ts);
      if (isNaN(d)) return '';
      const now = new Date();
      const opts = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
      if (d.getFullYear() !== now.getFullYear()) opts.year = 'numeric';
      return d.toLocaleString(undefined, opts);
    }
    
    function isMobile() {
      return window.innerWidth <= 768;
    }
    function createMemberCard(member) {
      var isTemp = String(member.id).startsWith('temp-');
      var defaultPhoto = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iNjAiIGZpbGw9IiNGRkQ3MDAiLz4KPHN2ZyB4PSI0MCIgeT0iMzAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMDAwIj4KPHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDEyIDJWMThjMC0yLjY2LTUuMzMtNC04LTR6Ii8+Cjwvc3ZnPgo8L3N2Zz4K';
      var photoSrc = member.photoURL || defaultPhoto;
      
      var tierBadges = [0,1,2,3,4].map(n => {
        var tier = tiers[n];
        var earned = (member.tier !== 'flushed' && member.tier >= n);
        return `<div class="tier-badge ${tier.class} ${earned?'earned':'not-earned'}">
        ${tier.icon} ${tier.name}
        </div>`;
      }).join('');
      var flushedBadge = member.tier==='flushed'
        ? `<div class="tier-badge ${tiers.flushed.class} earned">
        ${tiers.flushed.icon} ${tiers.flushed.name}
        </div>` : '';
      
        var allComments = Array.isArray(member.comments) ? member.comments : [];
        var userComment = allComments.find(c => c.author === currentUser);
        var otherComments = allComments.filter(c => c.author !== currentUser);
        
        var commentsHtml = [
            ...(userComment ? [userComment] : []),
            ...otherComments
        ].map(c => renderCommentHtml(c, member.id, isTemp)).join('');
      
      var likes = JSON.parse(member.likes || '[]');
      var dislikes = JSON.parse(member.dislikes|| '[]');
      var met = JSON.parse(member.met || '[]');
      var liked = likes.includes(currentUser);
      var disliked= dislikes.includes(currentUser);
      var meted = met.includes(currentUser);

      // Check if current user is first (creator)
      var isCreator = met.length > 0 && met[0] === currentUser;

      // --- NEW: Get the name of the person who added the recruit (first in met list) ---
      var addedBy = met.length > 0 ? met[0] : null;

      // Disable all actions if locked or temp
      var disabledAttr = (isTemp || isLocked)?'disabled':'';
      var tempStyle = (isTemp || isLocked)?'style="opacity:.5;cursor:not-allowed;"':'';
      
      return `
      <div class="member-header">
      <img src="${photoSrc}"
           alt="${member.name}"
           class="member-photo"
           loading="lazy"
           referrerpolicy="no-referrer"
           onclick="showEnlargedImage('${photoSrc}', '${member.name}')"
           style="cursor: pointer;"
           onerror="this.onerror=null; this.src='${defaultPhoto}'; this.style.background='#FFD700';">
      <div class="member-info">
      <h3>${member.name}</h3>
      <div class="tier-badges">
      ${tierBadges}${flushedBadge}
      </div>
      </div>
      </div>
      <div class="member-details">
      ${addedBy ? `<p style="color: var(--primary-gold); font-weight: 600; margin-bottom: 12px;">‚ú® Added by ${addedBy}</p>` : ''}
      ${member.email? `<p>üìß ${member.email}</p>`:''}
      ${member.phone? `<p>üì± ${member.phone}</p>`:''}
      ${member.instagram?`<p>üì∏ ${member.instagram}</p>`:''}
      ${(() => {
        const pcs = normalizePrimaryContacts(member.primaryContacts);
        return pcs.length ? `<p>üë• Contacts: ${pcs.join(', ')}</p>` : '';
        })()}
      </div>
      <div class="member-actions">
      <button class="action-btn" onclick="editMember('${member.id}')" ${disabledAttr} ${tempStyle}>‚úèÔ∏è Edit</button>
      <button class="action-btn${meted?' active-for-user':''}"
      onclick="markMet('${member.id}')"
      ${disabledAttr || (isCreator && meted) ? 'disabled' : ''}
      ${tempStyle || (isCreator && meted) ? 'style="opacity:.5;cursor:not-allowed;"' : ''}
      ${isCreator && meted ? 'data-tooltip="You added this recruit"' : ''}>
      I've met them ${isCreator && meted ? 'üîí' : ''}
      </button>
      <button class="action-btn${liked?' active-for-user':''}"
      onclick="like('${member.id}')"
      ${disabledAttr || (!meted) ? 'disabled' : ''}
      ${tempStyle || (!meted) ? 'style="opacity:.5;cursor:not-allowed;"' : ''}
      ${!meted ? 'data-tooltip="Must meet recruit first"' : ''}>
      üëç ${likes.length}
      </button>
      <button class="action-btn dislike${disliked?' active-for-user':''}"
      onclick="dislike('${member.id}')"
      ${disabledAttr || (!meted) ? 'disabled' : ''}
      ${tempStyle || (!meted) ? 'style="opacity:.5;cursor:not-allowed;"' : ''}
      ${!meted ? 'data-tooltip="Must meet recruit first"' : ''}>
      üëé ${dislikes.length}
      </button>
      ${
      position.includes("Rho")
      ? member.tier!=='flushed'
      ? `
      ${member.tier < 4?`<button class="action-btn" onclick="promoteToNextTier('${member.id}')" ${disabledAttr} ${tempStyle}>‚¨ÜÔ∏è Promote</button>`:''}
      ${member.tier > 0?`<button class="action-btn" onclick="demoteToTier('${member.id}',${member.tier-1})" ${disabledAttr} ${tempStyle}>‚¨áÔ∏è Demote</button>`:''}
      <button class="action-btn flush-btn" onclick="flushMember('${member.id}')" ${disabledAttr} ${tempStyle}>üöΩ Flush</button>
      <button class="action-btn" onclick="deleteMember('${member.id}')" ${disabledAttr} ${tempStyle}>üóë Delete</button>
      <button class="action-btn" onclick="showMetMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who've Met</button>
      <button class="action-btn" onclick="showLikeMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who Liked</button>
      <button class="action-btn" onclick="showDislikeMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who Disliked</button>
      `
      : `
      <button class="action-btn" onclick="showMetMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who've Met</button>
      <button class="action-btn" onclick="showLikeMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who Liked</button>
      <button class="action-btn" onclick="showDislikeMenu('${member.id}')" ${disabledAttr} ${tempStyle}>Bros Who Disliked</button>
      <button class="action-btn" onclick="unflushMember('${member.id}')" ${disabledAttr} ${tempStyle}>‚Ü©Ô∏è Unflush</button>
      <button class="action-btn" onclick="deleteMember('${member.id}')" ${disabledAttr} ${tempStyle}>üóë Delete</button>
      `
      : ``
      }
      </div>
      <div class="comments-section">
      <h4>Comments:</h4>
      <div class="comments-list" id="comments-list-${member.id}">${commentsHtml}</div>
      <div class="add-comment">
      <textarea
      id="comment-text-${member.id}"
      placeholder="${userComment?'Edit your comment‚Ä¶':'Add a comment‚Ä¶'}"
      ${disabledAttr}
      ${tempStyle}
      >${userComment?userComment.text:''}</textarea>
      <button
      onclick="addOrUpdateComment('${member.id}')"
      ${disabledAttr}
      ${tempStyle}
      >${userComment?'Update':'Add'}</button>
      </div>
      </div>
      `;
    }
    
    function openAddModal() {
      // SECURITY: Prevent adding new members if rush is locked OR globally disabled by admin
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot add new members to archived rush events.');
        return;
      }
      if (window.stateManager.localState.globalDisableAddRecruits) {
        alert('Adding new recruits is currently disabled by an administrator.');
        return;
      }
    
      currentFilter = 'all';
      sortMembers('all');
    
      editingMemberId = null;
      document.getElementById('modalTitle').textContent = 'Add New Member';
      document.getElementById('memberForm').reset();
      document.getElementById('memberModal').style.display = 'flex';
      trackModalState(true);
      if (!position.includes("Rho")) {
        document.getElementById('primaryContactsGroup').style.display = 'none';
      }
    }
    
    function editMember(id) {
      // SECURITY: Prevent editing members if rush is locked
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Editing is disabled for archived rush events.');
        return;
      }
    
      var member = members.find(m => String(m.id) === id);
      if (!member) {
        showMessage('Member not found for editing.', 'error');
        return;
      }
      if (!position.includes("Rho")) {
        document.getElementById('primaryContactsGroup').style.display = 'none';
      }
      editingMemberId = id;
      document.getElementById('modalTitle').textContent = 'Edit Member';
      document.getElementById('memberName').value = member.name;
      document.getElementById('memberEmail').value = member.email || '';
      document.getElementById('memberPhone').value = member.phone || '';
      document.getElementById('memberInstagram').value = member.instagram || '';
      document.getElementById('memberPhotoFile').value = '';
      var contactSelect = document.getElementById('primaryContacts');
      if (contactSelect) {
        Array.from(contactSelect.options).forEach(option => {
          const pcs = normalizePrimaryContacts(member.primaryContacts);
          option.selected = pcs.includes(option.value);
        });
      }
      document.getElementById('memberModal').style.display = 'flex';
      trackModalState(true);
    }
    
    // Optimized update function for better performance
    function updateMemberOptimistically(recruitId, field, updateFn) {
      const member = members.find(m => String(m.id) === recruitId);
      if (!member) return null;
      
      stateManager.version++;
      const opVersion = stateManager.version;
      
      const oldValue = member[field];
      const newValue = updateFn(member[field]);
      member[field] = newValue;
      
      stateManager.trackOperation(recruitId, field, newValue, opVersion);
      
      // Use throttled render for immediate UI feedback
      throttledRender();
      
      return function revert() {
        const pendingOp = stateManager.getPendingValue(recruitId, field);
        if (pendingOp && pendingOp.version === opVersion) {
          member[field] = oldValue;
          stateManager.clearOperation(recruitId, field);
          throttledRender();
        }
      };
    }
    
    async function deleteMember(id) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Deleting members is disabled.');
        return;
      }
      if (!confirm("Delete this member? This will permanently remove their record and photo.")) return;

      const idx = members.findIndex(m => String(m.id) === String(id));
      if (idx === -1) return;

      const deletedMember = members[idx];
      // Optimistic delete
      members.splice(idx, 1);
      throttledRender();

      try {
        const res = await fetch('/api/rush/recruits/' + currentRushEvent.recruitsTabId + '/' + id + window.location.search, {
          method: 'DELETE'
        });
        const result = await res.json();
        if (!res.ok || (result && result.success === false)) throw new Error((result && result.error) || 'Delete failed');

        stateManager.localState.members.delete(String(id));

      } catch (err) {
        // Rollback deletion
        members.splice(idx, 0, deletedMember);
        throttledRender();

        if (err.message && err.message.toLowerCase().includes('lock')) {
          showMessage('Server is busy. Please try again.', 'warning');
        } else {
          showMessage('Delete failed: ' + err.message, 'error');
        }
      }
    }
    
    function closeModal() {
      document.getElementById('memberModal').style.display = 'none';
      editingMemberId = null;
      trackModalState(false);
    }
    
    function isDuplicateName(name, editingId) {
      return members.some(m =>
        m.name.trim().toLowerCase() === name.trim().toLowerCase()
        && String(m.id) !== String(editingId)
      );
    }
    
    function handleMemberFormSubmit(e) {
      e.preventDefault();
    
      var isEdit = Boolean(editingMemberId);
      var id = editingMemberId || '';
      var name = document.getElementById('memberName').value;
      var email = document.getElementById('memberEmail').value;
      var phone = document.getElementById('memberPhone').value;
      var instagram = document.getElementById('memberInstagram').value;
      var contacts = Array.from(
        document.getElementById('primaryContacts').selectedOptions
      ).map(o => o.value);
      var contactsJson = JSON.stringify(contacts);
      var file = document.getElementById('memberPhotoFile').files[0];
    
      if (isDuplicateName(name, id)) {
        closeModal();
        showMessage(`A member named "${name}" already exists.`, 'error');
        document.getElementById('errorMessage').scrollIntoView({ behavior: 'smooth' });
        return;
      }
    
      async function doSave(base64Data) {
        if (isEdit) {
          const member = members.find(m => String(m.id) === id);
          if (!member) return;

          const oldData = { ...member };
          Object.assign(member, {
            name, email, phone, instagram,
            primaryContacts: contacts,
            ...(base64Data ? { photoURL: base64Data } : {})
          });

          // Optimistic UI update
          stateManager.trackOperation(id, 'primaryContacts', contacts, ++stateManager.version);
          const card = document.querySelector(`[data-member-id="${id}"]`);
          if (card) { updateCardContent(card, member); } else { throttledRender(); }
          closeModal();

          try {
            const res = await fetch('/api/rush/recruits/save' + window.location.search, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                recruitsTabId: currentRushEvent.recruitsTabId,
                id,
                name,
                email,
                phone,
                instagram,
                contactsJson,
                base64Data: base64Data || null,
                addedBy: currentUser
              })
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Save failed');

            stateManager.clearOperation(id, 'primaryContacts');
            stateManager.localState.members.set(String(id), { ...member });

          } catch (err) {
            // Rollback optimistic update
            Object.assign(member, oldData);
            stateManager.clearOperation(id, 'primaryContacts');
            const card = document.querySelector(`[data-member-id="${id}"]`);
            if (card) { updateCardContent(card, member); } else { throttledRender(); }

            // Check for lock errors
            if (err.message && err.message.toLowerCase().includes('lock')) {
              showMessage('Server is busy. Please try again in a moment.', 'warning');
            } else {
              onFailure(err);
            }
          }
        } else {
          const tempId = `temp-${Date.now()}`;
          const tempMember = {
            id: tempId, name, email, phone, instagram,
            primaryContacts: contacts,
            tier: 0,
            photoURL: base64Data || '',
            likes: '[]', dislikes: '[]', met: JSON.stringify([currentUser]), comments: []
          };
    
          members.unshift(tempMember); // Add to beginning of array
          stateManager.localState.members.set(tempId, { ...tempMember });
          
          currentFilter = 'all';
          searchTerm = ''; // Clear search to ensure new member is visible
          
          // Clear search input if it exists
          const searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.value = '';
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
              clearBtn.classList.add('hidden');
            }
          }
          
          //          cardIdToScrollTo = tempId;
          throttledRender();
          closeModal();

          fetch('/api/rush/recruits/save' + window.location.search, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              recruitsTabId: currentRushEvent.recruitsTabId,
              id: '',
              name,
              email,
              phone,
              instagram,
              contactsJson: JSON.stringify(contacts),
              base64Data: base64Data || null,
              addedBy: currentUser
            })
          })
            .then(function(r) {
              return r.json().then(function(data) {
                if (!r.ok) throw new Error((data && data.error) || 'Save failed');
                return data;
              });
            })
            .then(function(newMemberId) {
              const idx = members.findIndex(m => m.id === tempId);
              if (idx > -1) {
                const realMember = { ...tempMember, id: newMemberId };
                members[idx] = realMember;

                stateManager.localState.members.delete(tempId);
                stateManager.localState.members.set(newMemberId, realMember);

                if (cardIdToScrollTo === tempId) {
                  cardIdToScrollTo = newMemberId;
                }

                throttledRender();
              }
            })
            .catch(function(err) {
              members = members.filter(m => m.id !== tempId);
              stateManager.localState.members.delete(tempId);
              cardIdToScrollTo = null;
              throttledRender();
              onFailure(err);
            });
        }
      }
    
      // Rest of the file handling code remains the same...
      function compressToTargetSize(file, targetBytes, callback) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
    
            const MAX_WIDTH = 800;
            const MAX_HEIGHT = 800;
            let width = img.width;
            let height = img.height;
    
            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
    
            let quality = 0.9;
            let compressedData;
    
            for (let i = 0; i < 10; i++) {
              compressedData = canvas.toDataURL('image/jpeg', quality);
              const currentSize = compressedData.length * 0.75;
              
              if (currentSize <= targetBytes) {
                break;
              }
              
              quality -= 0.1;
              if (quality < 0.1) {
                quality = 0.1;
              }
            }
            callback(compressedData);
          };
          img.onerror = () => callback(null);
          img.src = e.target.result;
        };
        reader.onerror = () => callback(null);
        reader.readAsDataURL(file);
      }
    
      if (!file) {
        doSave(null);
      } else {
        if (file.size > 500000 || file.type === 'image/heic' || file.type === 'image/heif') {
          compressToTargetSize(file, 40000, function(compressedData) { doSave(compressedData); });
        } else {
          var reader = new FileReader();
          reader.onload = () => doSave(reader.result);
          reader.onerror = () => doSave(null);
          reader.readAsDataURL(file);
        }
      }
    }
    
    function promoteToNextTier(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Tier changes are disabled.');
        return;
      }

      const revert = updateMemberOptimistically(recruitId, 'tier', (currentTier) => {
        return currentTier < 4 ? currentTier + 1 : currentTier;
      });

      fireConfetti();

      // Debounce the backend update - only send the final tier value
      stateManager.debounceUpdate(recruitId, 'tier', () => {
        const currentMember = members.find(m => String(m.id) === recruitId);
        if (!currentMember) return;

        fetch('/api/rush/recruits/tier' + window.location.search, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId, tier: currentMember.tier })
        })
          .then(function(r) { return r.json(); })
          .then(function() {
            stateManager.clearOperation(recruitId, 'tier');
          })
          .catch(function(err) {
            const member = members.find(m => String(m.id) === recruitId);
            if (member) {
              member.tier = 0;
              throttledRender();
            }
            showMessage(`Failed to promote ${member ? member.name : 'recruit'}.`, 'error');
          });
      }, 300);
    }
    
    function demoteToTier(id, newTier) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Tier changes are disabled.');
        return;
      }

      const revert = updateMemberOptimistically(id, 'tier', () => newTier);

      shakeGrid();

      // Debounce the backend update
      stateManager.debounceUpdate(id, 'tier', () => {
        const currentMember = members.find(m => String(m.id) === id);
        if (!currentMember) return;

        fetch('/api/rush/recruits/tier' + window.location.search, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId: id, tier: currentMember.tier })
        })
          .then(function(r) { return r.json(); })
          .then(function() {
            stateManager.clearOperation(id, 'tier');
          })
          .catch(function(err) {
            const member = members.find(m => String(m.id) === id);
            if (member) {
              member.tier = 0;
              throttledRender();
            }
            showMessage(`Failed to demote ${member ? member.name : 'recruit'}.`, 'error');
          });
      }, 300);
    }
    
    function flushMember(id) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Tier changes are disabled.');
        return;
      }
    
      const revert = updateMemberOptimistically(id, 'tier', () => 'flushed');
    
      var toilet = document.createElement('img');
      toilet.src = 'https://media.tenor.com/hyGeqFGZwe0AAAAM/what-is-that-it-looks-scary.gif';
      toilet.className = 'flush-animation';
      document.body.appendChild(toilet);
      setTimeout(() => { if (document.body.contains(toilet)) { document.body.removeChild(toilet); } }, 2000);
      
      fetch('/api/rush/recruits/tier' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId: id, tier: 'flushed' })
      })
        .then(function(r) { return r.json(); })
        .then(function() {
          stateManager.clearOperation(id, 'tier');
        })
        .catch(function(err) {
          if (revert) revert();
          const member = members.find(m => String(m.id) === id);
          showMessage(`Failed to flush ${member.name}.`, 'error');
        });
    }
    
    function unflushMember(id) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). Tier changes are disabled.');
        return;
      }
    
      const revert = updateMemberOptimistically(id, 'tier', () => 0);
    
      var plunger = document.createElement('img');
      plunger.src = 'https://media.tenor.com/dRGB2NB3H20AAAAM/plunger.gif';
      plunger.className = 'plunger-animation';
      document.body.appendChild(plunger);
      setTimeout(() => { if (document.body.contains(plunger)) { document.body.removeChild(plunger); } }, 2000);
      
      fetch('/api/rush/recruits/tier' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId: id, tier: 0 })
      })
        .then(function(r) { return r.json(); })
        .then(function() {
          stateManager.clearOperation(id, 'tier');
        })
        .catch(function(err) {
          if (revert) revert();
          const member = members.find(m => String(m.id) === id);
          showMessage(`Failed to unflush ${member.name}.`, 'error');
        });
    }
    
    function addOrUpdateComment(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot add or edit comments in archived rush events.');
        return;
      }
      if (window.stateManager.localState.globalDisableCommenting) {
        alert('Commenting is currently disabled by an administrator.');
        return;
      }
      const currentUserDisabledForCommenting = window.stateManager.localState.disabledBrotherSettings[currentUserEmail]?.commenting || false;
      if (currentUserDisabledForCommenting) {
        alert('You have been disabled from commenting by an administrator.');
        return;
      }
      if (String(recruitId).startsWith('temp-')) return;
    
      const input = document.getElementById(`comment-text-${recruitId}`);
      const text = input.value.trim();
      if (!text) {
        showMessage('Comment cannot be empty.', 'error');
        return;
      }
      
      const member = members.find(m => String(m.id) === recruitId);
      if (!member) return;
      
      const now = Date.now();
      const newComment = {
        author: currentUser,
        text,
        recruitId,
        timestamp: now,   // optimistic time (epoch ms)
      };
      
      // Initialize comments array if it doesn't exist
      if (!member.comments) {
        member.comments = [];
      }
      
      const oldComments = [...member.comments];
      const existingIndex = member.comments.findIndex(c => c.author === currentUser);
      
      if (existingIndex > -1) {
        member.comments[existingIndex] = newComment;
      } else {
        member.comments.push(newComment);
      }
      
      // Update local state
      stateManager.localState.members.set(String(recruitId), { ...member });
      stateManager.trackOperation(recruitId, 'comments', member.comments, ++stateManager.version);
      
      // Force re-render of just this card's comments section
      updateCardComments(recruitId, member.comments);
      
      // Visual feedback
      popComment(recruitId);
      
      fetch('/api/rush/comments/save' + window.location.search, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commentsTabId: currentRushEvent.commentsTabId, recruitId, text })
      })
        .then(function(r) { return r.json(); })
        .then(function() {
          stateManager.clearOperation(recruitId, 'comments');
          const card = document.querySelector(`[data-member-id="${recruitId}"]`);
          if (card) {
            updateCardContent(card, member);
          }
        })
        .catch(function(err) {
          member.comments = oldComments;
          stateManager.clearOperation(recruitId, 'comments');
          input.value = text;
          throttledRender();
          showMessage(`Failed to save comment.`, 'error');
        });
    }
    
    function updateCardComments(recruitId, comments) {
      const commentsList = document.getElementById(`comments-list-${recruitId}`);
      if (!commentsList) return;
  
      const member = members.find(m => String(m.id) === String(recruitId));
      const isTemp = String(recruitId).startsWith('temp-');
  
      const userComment = comments.find(c => c.author === currentUser);
      const otherComments = comments.filter(c => c.author !== currentUser);
  
      const commentsHtml = [
          ...(userComment ? [userComment] : []),
          ...otherComments
      ].map(c => renderCommentHtml(c, recruitId, isTemp)).join('');
  
      commentsList.innerHTML = commentsHtml;
  
      // Update the add/update button text
      const addCommentBtn = commentsList.closest('.comments-section').querySelector('.add-comment button');
      if (addCommentBtn) {
          addCommentBtn.textContent = userComment ? 'Update' : 'Add';
      }
  }
    
    function normalizePrimaryContacts(pc) {
      if (!pc) return [];
      if (Array.isArray(pc)) return pc;
      if (typeof pc === 'string') {
        try {
          const arr = JSON.parse(pc);
          return Array.isArray(arr) ? arr : [];
        } catch { return []; }
      }
      return [];
    }
    
    function editComment(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot edit comments in archived rush events.');
        return;
      }
    
      var input = document.getElementById(`comment-text-${recruitId}`);
      var member = members.find(m => String(m.id) === recruitId);
      if (member) {
        var userComment = member.comments.find(c => c.author === currentUser);
        if (userComment) {
          input.value = userComment.text;
          input.focus();
          uiState.isEditingComment = true;
          uiState.activeCommentTextarea = input.id;
        }
      }
    }
    
    function like(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot like/unlike recruits in archived rush events.');
        return;
      }
      const currentUserDisabledForInteractions = window.stateManager.localState.disabledBrotherSettings[currentUserEmail]?.intereractions || false;
      if (currentUserDisabledForInteractions) {
        alert('You have been disabled from interactions by an administrator.');
        return;
      }

      // Check if user has met the recruit
      const member = members.find(m => String(m.id) === recruitId);
      if (member) {
        const met = JSON.parse(member.met || '[]');
        if (!met.includes(currentUser)) {
          showMessage("You must meet this recruit before liking them.", 'info');
          return;
        }
      }

      const revertLikes = updateMemberOptimistically(recruitId, 'likes', (currentLikes) => {
        let likes = JSON.parse(currentLikes || '[]');
        const idx = likes.indexOf(currentUser);
        if (idx > -1) {
          likes.splice(idx, 1);
        } else {
          likes.push(currentUser);
        }
        return JSON.stringify(likes);
      });
    
      const revertDislikes = updateMemberOptimistically(recruitId, 'dislikes', (currentDislikes) => {
        let dislikes = JSON.parse(currentDislikes || '[]');
        return JSON.stringify(dislikes.filter(u => u !== currentUser));
      });

      // Debounce the backend update
      stateManager.debounceUpdate(recruitId, 'likes', () => {
        fetch('/api/rush/recruits/like' + window.location.search, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId })
        })
          .then(function(r) { return r.json(); })
          .then(function() {
            stateManager.clearOperation(recruitId, 'likes');
            stateManager.clearOperation(recruitId, 'dislikes');
          })
          .catch(function(err) {
            if (revertLikes) revertLikes();
            if (revertDislikes) revertDislikes();
            showMessage(`Failed to update like. Please try again.`, 'error');
          });
      }, 300);
    }
    
    function dislike(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot dislike recruits in archived rush events.');
        return;
      }
      const currentUserDisabledForInteractions = window.stateManager.localState.disabledBrotherSettings[currentUserEmail]?.intereractions || false;
      if (currentUserDisabledForInteractions) {
        alert('You have been disabled from interactions by an administrator.');
        return;
      }

      // Check if user has met the recruit
      const member = members.find(m => String(m.id) === recruitId);
      if (member) {
        const met = JSON.parse(member.met || '[]');
        if (!met.includes(currentUser)) {
          showMessage("You must meet this recruit before disliking them.", 'info');
          return;
        }
      }

      const revertDislikes = updateMemberOptimistically(recruitId, 'dislikes', (currentDislikes) => {
        let dislikes = JSON.parse(currentDislikes || '[]');
        const idx = dislikes.indexOf(currentUser);
        if (idx > -1) {
          dislikes.splice(idx, 1);
        } else {
          dislikes.push(currentUser);
        }
        return JSON.stringify(dislikes);
      });
    
      const revertLikes = updateMemberOptimistically(recruitId, 'likes', (currentLikes) => {
        let likes = JSON.parse(currentLikes || '[]');
        return JSON.stringify(likes.filter(u => u !== currentUser));
      });

      // Debounce the backend update
      stateManager.debounceUpdate(recruitId, 'dislikes', () => {
        fetch('/api/rush/recruits/dislike' + window.location.search, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId })
        })
          .then(function(r) { return r.json(); })
          .then(function() {
            stateManager.clearOperation(recruitId, 'likes');
            stateManager.clearOperation(recruitId, 'dislikes');
          })
          .catch(function(err) {
            if (revertLikes) revertLikes();
            if (revertDislikes) revertDislikes();
            showMessage(`Failed to update dislike. Please try again.`, 'error');
          });
      }, 300);
    }

    function deleteComment(recruitId, authorName) {
  if (isLocked) {
      alert('This rush event is locked. Deleting comments is disabled.');
      return;
  }
  
  if (!confirm("Are you sure you want to delete this comment?")) return;

  const member = members.find(m => String(m.id) === String(recruitId));
  if (!member) return;

  // Snapshot for rollback
  const originalComments = [...(member.comments || [])];

  // Optimistic Update: Filter out the comment by the specific author
  // (Note: This logic assumes 1 comment per author per recruit, which fits your data model)
  member.comments = (member.comments || []).filter(c => c.author !== authorName);

  // Update Local State
  stateManager.trackOperation(recruitId, 'comments', member.comments, ++stateManager.version);
  stateManager.localState.members.set(String(recruitId), { ...member });

  // Render Update
  updateCardComments(recruitId, member.comments);
  
  // If we deleted our own comment, clear the input box
  if (authorName === currentUser) {
      const input = document.getElementById(`comment-text-${recruitId}`);
      if (input) input.value = '';
  }

  // Backend Call
  fetch('/api/rush/comments/delete' + window.location.search, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ commentsTabId: currentRushEvent.commentsTabId, recruitId, authorName })
  })
    .then(function(r) { return r.json(); })
    .then(function() {
      stateManager.clearOperation(recruitId, 'comments');
      console.log(`Comment by ${authorName} deleted successfully`);
    })
    .catch(function(err) {
      member.comments = originalComments;
      stateManager.clearOperation(recruitId, 'comments');
      stateManager.localState.members.set(String(recruitId), { ...member });
      updateCardComments(recruitId, member.comments);
      showMessage(`Failed to delete comment: ${err.message || err}`, 'error');
    });
}
    
    function markMet(recruitId) {
      if (isLocked) {
        alert('This rush event is locked (view-only mode). You cannot mark recruits as met in archived rush events.');
        return;
      }
      const currentUserDisabledForInteractions = window.stateManager.localState.disabledBrotherSettings[currentUserEmail]?.intereractions || false;
      if (currentUserDisabledForInteractions) {
        alert('You have been disabled from interactions by an administrator.');
        return;
      }

      // Check if user is trying to unmet and they're the first person (creator)
      const member = members.find(m => String(m.id) === recruitId);
      if (member) {
        const met = JSON.parse(member.met || '[]');
        // If user is first in met list and already met, prevent unmetting
        if (met.length > 0 && met[0] === currentUser && met.includes(currentUser)) {
          showMessage("You added this recruit and cannot unmet them.", 'info');
          return;
        }
      }

      const revert = updateMemberOptimistically(recruitId, 'met', (currentMet) => {
        let met = JSON.parse(currentMet || '[]');
        const idx = met.indexOf(currentUser);
        if (idx > -1) {
          met.splice(idx, 1);
        } else {
          met.push(currentUser);
        }
        return JSON.stringify(met);
      });

      // Debounce the backend update
      stateManager.debounceUpdate(recruitId, 'met', () => {
        console.log(`Calling backend addMet for ${recruitId}, user: ${currentUser}, session: ${RUSH_SESSION_ID}`);
        fetch('/api/rush/recruits/met' + window.location.search, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabId: currentRushEvent.recruitsTabId, recruitId })
        })
          .then(function(r) { return r.json(); })
          .then(function() {
            console.log(`Successfully updated met status for ${recruitId}`);
            stateManager.clearOperation(recruitId, 'met');
          })
          .catch(function(err) {
            console.error(`Failed to update met status:`, err);
            if (revert) revert();
            showMessage(`Failed to update 'met' status: ${err.message || err}`, 'error');
          });
      }, 300);
    }
    
    function sortMembers(filter) {
      currentFilter = filter;
      searchTerm = '';
      throttledRender();
      updateControlsStats();
      
      // Close the panel after selection on mobile
      if (window.innerWidth <= 768) {
        const toggle = document.getElementById('controlsToggle');
        const panel = document.getElementById('controlsPanel');
        if (toggle && panel) {
          controlsOpen = false;
          toggle.classList.remove('active');
          panel.classList.remove('open');
        }
      }
    }
    
    function isMemberFormDirty() {
      var form = document.getElementById('memberForm');
      if (!form) return false;
      if (!editingMemberId) {
        return (
          form.memberName.value.trim() ||
          form.memberEmail.value.trim() ||
          form.memberPhone.value.trim() ||
          form.memberInstagram.value.trim() ||
          form.memberPhotoFile.files.length > 0 ||
          Array.from(form.primaryContacts.selectedOptions).length > 0
        );
      } else {
        return true;
      }
    }
    
    function requestCloseModal() {
      if (isMemberFormDirty()) {
        if (confirm("You have unsaved changes‚Äîdiscard them and close?")) {
          closeModal();
        }
      } else {
        closeModal();
      }
    }
    
    document.getElementById('memberModal').addEventListener('click', function(e) {
      if (e.target !== this) return;
      requestCloseModal();
    });
    
    function showMetMenu(recruitId) {
      var member = members.find(m => String(m.id) === String(recruitId));
      if (!member) { showMessage('Member not found', 'error'); return; }
      var metArr = Array.isArray(member.met) ? member.met : JSON.parse(member.met || '[]');
      var allBros = Array.isArray(contacts) ? contacts : [];
      var notMetArr = allBros.filter(bro => !metArr.includes(bro));
      document.getElementById('metModal')?.remove();
      var modal = document.createElement('div');
      modal.id = 'metModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:400px;">
          <h2>${member.name}</h2>
          <div style="margin-top:10px">
            <h3>‚úÖ Met</h3>
            <ul>${metArr.map(bro => `<li>${bro}</li>`).join('') || '<li><em>None yet</em></li>'}</ul>
            <h3>‚ùå Not Met</h3>
            <ul>${notMetArr.map(bro => `<li>${bro}</li>`).join('') || '<li><em>All bros have met</em></li>'}</ul>
          </div>
          <div class="form-actions" style="justify-content:center; margin-top:20px;">
            <button class="btn" id="closeMetModal">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      document.getElementById('closeMetModal').addEventListener('click', () => { modal.remove(); });
    }
    
    function showLikeMenu(recruitId) {
      var member = members.find(m => String(m.id) === String(recruitId));
      if (!member) return showMessage('Member not found', 'error');
      var likesArr = Array.isArray(member.likes) ? member.likes : JSON.parse(member.likes || '[]');
      document.getElementById('likesModal')?.remove();
      var modal = document.createElement('div');
      modal.id = 'likesModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:400px;">
          <h2>${member.name}</h2>
          <h3>üëç Liked by</h3>
          <ul>
            ${likesArr.length ? likesArr.map(u => `<li>${u}</li>`).join('') : '<li><em>No one has liked them yet.</em></li>'}
          </ul>
          <div class="form-actions" style="justify-content:center; margin-top:20px;">
            <button class="btn" id="closeLikesModal">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      document.getElementById('closeLikesModal').onclick = () => modal.remove();
    }
    
    function showDislikeMenu(recruitId) {
      var member = members.find(m => String(m.id) === String(recruitId));
      if (!member) return showMessage('Member not found', 'error');
      var disArr = Array.isArray(member.dislikes) ? member.dislikes : JSON.parse(member.dislikes || '[]');
      document.getElementById('dislikesModal')?.remove();
      var modal = document.createElement('div');
      modal.id = 'dislikesModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:400px;">
          <h2>${member.name}</h2>
          <h3>üëé Disliked by</h3>
          <ul>
            ${disArr.length ? disArr.map(u => `<li>${u}</li>`).join('') : '<li><em>No one has disliked them yet.</em></li>'}
          </ul>
          <div class="form-actions" style="justify-content:center; margin-top:20px;">
            <button class="btn" id="closeDislikesModal">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      document.getElementById('closeDislikesModal').onclick = () => modal.remove();
    }
    
    function showEnlargedImage(imageSrc, memberName) {
      // Remove any existing image modal
      document.getElementById('imageModal')?.remove();
    
      // Create the modal
      var modal = document.createElement('div');
      modal.id = 'imageModal';
      modal.className = 'modal image-modal';
      modal.innerHTML = `
        <div class="image-modal-content">
          <span class="image-modal-close" id="closeImageModal">&times;</span>
          <img src="${imageSrc}" alt="${memberName}" class="enlarged-image">
          <div class="image-modal-caption">${memberName}</div>
        </div>`;
    
      document.body.appendChild(modal);
      modal.style.display = 'flex';
    
      // Close when clicking the X button
      document.getElementById('closeImageModal').addEventListener('click', () => {
        modal.remove();
      });
    
      // Close when clicking outside the image
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    
      // Close with Escape key
      var escapeHandler = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }
    
    </script>
    
    </body>
    </html><!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Fraternity Recruitment Dashboard</title>
      <style>
      /* Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
    
      :root {
        --primary-gold: #FFD700;
        --secondary-gold: #FFA500;
        --bg-dark: #0a0a0a;
        --bg-secondary: #1a1a1a;
        --bg-card: rgba(255, 255, 255, 0.05);
        --border-color: rgba(255, 215, 0, 0.2);
        --text-primary: #ffffff;
        --text-secondary: #b8b8b8;
        --success: #4CAF50;
        --error: #f44336;
        --shadow-gold: rgba(255, 215, 0, 0.3);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
    
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        position: relative;
        overflow-x: hidden;
      }
    
      /* Card enter animation - moved to main CSS to avoid duplication */
      .member-card-enter {
        animation: cardEnter 0.3s ease-out;
      }
      
      @keyframes cardEnter {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    
      /* Typography */
      .header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        z-index: 10;
      }
    
      .header h1 {
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 800;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        margin-bottom: 0.5rem;
        text-shadow: 0 0 30px var(--shadow-gold);
      }
    
      .rush-event-header {
        text-align: center;
        margin-bottom: 2rem;
      }
    
      .rush-event-header h2 {
        font-size: clamp(1.5rem, 4vw, 2rem);
        color: var(--primary-gold);
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
    
      /* Back to Archives Button */
      .back-to-archives-btn {
        display: inline-block;
        padding: 0.6rem 1.5rem;
        background: rgba(255, 215, 0, 0.1);
        color: var(--primary-gold);
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        border: 2px solid var(--primary-gold);
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
      }
    
      .back-to-archives-btn:hover {
        background: var(--primary-gold);
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
      }

      .admin-menu-btn {
        background: var(--primary-gold);
        color: #000;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
      }

      .quick-controls {
        text-align: center;
        margin-bottom: 20px;
      }

      .admin-menu {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 20px;
        margin: 20px auto;
        max-width: 800px;
      }

      .admin-menu h3 {
        color: var(--primary-gold);
        margin-bottom: 15px;
      }

      .admin-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .admin-option label {
        flex: 1;
      }

      .admin-option input[type="checkbox"] {
        margin-right: 10px;
      }

      .admin-option select {
        flex: 1;
        margin-right: 10px;
      }

      .admin-option-group {
        border-top: 1px solid var(--border-color);
        padding-top: 15px;
        margin-top: 20px;
      }

      .admin-option-group h4 {
        color: var(--text-primary);
        margin-bottom: 15px;
      }

      #selectBrotherToManage {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        margin-bottom: 10px;
      }

      #brotherSpecificControls button {
        background: var(--primary-gold);
        color: #000;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
      }


    
      /* SSE Status Indicator */
      .sse-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
      }
    
      @media (min-width: 769px) {
        .sse-status { right: 80px; }
      }
    
      .sse-status.connected {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #4CAF50;
      }
    
      .sse-status.disconnected {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.4);
        color: #f44336;
      }
    
      .sse-status.reconnecting {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid rgba(255, 193, 7, 0.4);
        color: #FFC107;
      }
    
      .sse-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }
    
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Tooltip for locked buttons */
      .action-btn[data-tooltip] {
        position: relative;
      }

      .action-btn[data-tooltip]:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
        animation: tooltipFade 0.2s ease-in;
      }

      @keyframes tooltipFade {
        from { opacity: 0; transform: translateX(-50%) translateY(4px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }

      /* Locked Banner Styles */
      .locked-banner {
        background: linear-gradient(135deg, rgba(255, 165, 0, 0.15) 0%, rgba(255, 140, 0, 0.1) 100%);
        border: 2px solid rgba(255, 165, 0, 0.4);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin: 1rem auto 2rem;
        max-width: 800px;
        box-shadow: 0 4px 15px rgba(255, 165, 0, 0.2);
      }
    
      .locked-banner-content {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
    
      .locked-icon {
        font-size: 2rem;
        filter: drop-shadow(0 2px 4px rgba(255, 165, 0, 0.3));
      }
    
      .locked-text strong {
        color: #FFA500;
        font-size: 1.1rem;
        display: block;
        margin-bottom: 0.25rem;
      }
    
      .locked-text p {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.4;
      }
    
    .controls-wrapper {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100;
      }
    
    @media (min-width: 769px) {
      .controls-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 20px;
        min-width: 280px;
        max-width: 320px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        z-index: 1000;
    
        opacity: 0;
        visibility: hidden;
        transform: translateX(8px);
        pointer-events: none;
        transition: var(--transition);
      }
    
      /* Ensure the open state overrides the above on desktop too */
      .controls-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
        pointer-events: auto;
      }
    }
      
      /* Ensure the controls wrapper doesn't block content */
      .controls-wrapper {
        pointer-events: none;
      }
      
      .controls-wrapper > * {
        pointer-events: auto;
      }
      
      /* Additional fix for member cards being blocked */
      .member-card {
        position: relative;
        z-index: 1;
      }
      
      /* Ensure member actions have proper z-index */
      .member-actions {
        position: relative;
        z-index: 10;
      }
      
      .action-btn {
        position: relative;
        z-index: 10;
      }
      
      /* Modal menus should be above everything */
      .modal {
        z-index: 2000 !important;
      }
      
      /* Ensure hover states work properly */
      .member-card:hover {
        z-index: 2;
      }
      
      /* Special modals for "Bros who liked/disliked/met" */
      #metModal,
      #likesModal,
      #dislikesModal {
        z-index: 3000 !important;
      }
    
      .controls-toggle {
        background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
        color: #000;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        box-shadow: 0 4px 20px var(--shadow-gold);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
    
      .controls-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px var(--shadow-gold);
      }
    
      .controls-toggle.active {
        transform: rotate(45deg);
      }
    
      .controls-section {
        margin-bottom: 20px;
      }
    
      .controls-section:last-child {
        margin-bottom: 0;
      }
    
      /* Quick action buttons in panel */
      .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
    
      .quick-action-btn {
        background: rgba(255, 255, 255, 0.08);
        color: var(--primary-gold);
        border: 1px solid rgba(255, 215, 0, 0.3);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 8px;
      }
    
      .quick-action-btn:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: var(--primary-gold);
        transform: translateX(-2px);
      }
    
      /* Minimal top bar */
      /* SSE Refresh Button */
      .sse-refresh-btn {
        position: relative;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .sse-refresh-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(180deg);
      }

      .sse-refresh-btn.spinning {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .top-bar {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(10, 10, 10, 0);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
        padding: 15px 20px;
        z-index: 50;
        display: flex;
        align-items: center;
        gap: 20px;
      }
    
      .top-bar .search-container {
        flex: 1;
        max-width: 500px;
        margin: 0 auto;
      }
    
      .top-rushers-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(45deg, var(--primary-gold), #FFAA00);
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        white-space: nowrap;
      }
    
      .top-rushers-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
      }
    
      .top-rushers-btn:active {
        transform: translateY(0);
      }
    
      /* Hide the old controls */
      .controls {
        display: none !important;
      }
    
      /* Add smooth scroll behavior */
      html {
        scroll-behavior: smooth;
      }
    
      /* Card highlight animation for new members */
      @keyframes highlightNew {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.8);
        }
        50% {
          box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.4);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
        }
      }
    
      .member-card.highlight-new {
        animation: highlightNew 1s ease-out 2;
      }
    
      /* Mobile optimizations */
      @media (max-width: 768px) {
      /* Optimize top bar for mobile */
      .top-bar {
        flex-wrap: wrap;
        padding: 10px;
        gap: 8px;
        justify-content: space-between;
      }
    
      .top-bar .search-container {
        order: 2;
        flex: 1 1 100%;
        max-width: none;
        margin-top: 4px;
      }
    
      .top-bar-buttons {
        order: 1;
        display: flex !important;
        gap: 6px !important;
        flex: 0 0 auto;
      }
    
      .top-rushers-btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
        flex: 0 1 auto;
        min-width: fit-content;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
    
      #allScoresBtn {
        margin-left: 0;
      }
    
      /* Extra small screens */
      @media (max-width: 380px) {
        .top-rushers-btn {
          font-size: 0.75rem;
          padding: 0.45rem 0.6rem;
        }
    
        .top-rushers-btn .emoji {
          display: inline-block;
          margin-right: 2px;
        }
      }
    
      /* Hide desktop controls */
      .controls-wrapper {
        display: none !important;
      }
    
      /* The main container for the drawer */
      .drawer-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 200;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.4);
        transform: translateY(calc(100% - 50px));
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding-top: 20px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      
    
      .drawer-container.open {
        transform: translateY(0);
      }
    
      /* The grab handle visual cue */
      .drawer-handle {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 2.5px;
        cursor: grab;
      }
    
      /* Controls panel inside drawer */
      .drawer-container .controls-panel {
        position: static !important;
        transform: none !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 100%;
        overflow-y: auto;
        padding: 20px;
        background: transparent;
        border: none;
        box-shadow: none;
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
    
      /* Overlay to close the drawer on tap */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 199;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
    
      .drawer-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }
    
      .drawer-container::after {
        content: "Swipe up for controls";
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: var(--text-secondary);
        font-size: 12px;
        opacity: 0.7;
      }
      
      .drawer-container.open::after {
        display: none;
      }
    }
    
      /* Smooth transitions for member cards - reduced for performance */
      .member-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        will-change: transform, box-shadow;
      }
    
      /* Stats display in controls panel */
      .stats-display {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
      }
    
      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 14px;
      }
    
      .stat-item:last-child {
        margin-bottom: 0;
      }
    
      .stat-label {
        color: var(--text-secondary);
      }
    
      .stat-value {
        color: var(--primary-gold);
        font-weight: 600;
      }
    
      .search-container {
        flex: 1 1 300px;
        max-width: 400px;
        position: relative;
      }
    
      .search-container input {
        width: 100%;
        padding: 12px 45px 12px 45px;
        border-radius: 30px;
        border: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        font-size: 16px;
        transition: var(--transition);
        -webkit-appearance: none;
      }
    
      .search-container::before {
        content: "üîç";
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        z-index: 1;
        pointer-events: none;
      }
    
      .search-container input:focus {
        outline: none;
        border-color: var(--primary-gold);
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
      }
    
      .search-container input::placeholder {
        color: var(--text-secondary);
      }
    
      .clear-search-btn {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        line-height: 1;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s, opacity 0.2s;
        opacity: 0.7;
      }
      .clear-search-btn:hover {
          color: var(--text-primary);
          opacity: 1;
      }
      .clear-search-btn.hidden {
          display: none;
      }
    
      /* Buttons */
      .btn {
        background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
        color: #000;
        border: none;
        padding: 12px 28px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        transition: var(--transition);
        box-shadow: 0 4px 20px var(--shadow-gold);
        position: relative;
        overflow: hidden;
        white-space: nowrap;
      }
    
      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }
    
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px var(--shadow-gold);
      }
    
      .btn:hover::before {
        left: 100%;
      }
    
      .btn:active {
        transform: translateY(0);
      }
    
      .cancel-btn {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 12px 24px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
    
      .cancel-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
      }
    
      /* Sort Controls */
      .sort-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
    
      .sort-btn {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        border: 1px solid rgba(255, 215, 0, 0.2);
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
    
      .sort-btn:hover {
        background: rgba(255, 215, 0, 0.15);
        border-color: var(--primary-gold);
        transform: translateY(-1px);
      }
    
      .sort-btn.active {
        background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
        color: #000;
        border-color: transparent;
        box-shadow: 0 2px 10px var(--shadow-gold);
      }
    
      /* Members Grid */
      .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
        transition: opacity 0.2s ease;
      }
    
      /* Member Card */
      .member-card {
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 24px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 600px;
      }
    
      .member-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.5s;
        pointer-events: none;
      }
    
      .member-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 30px var(--shadow-gold);
        border-color: var(--primary-gold);
      }
    
      .member-card:hover::before {
        opacity: 1;
      }
      /* Additional fix for member card hover states */
    .member-card:hover {
      z-index: 2;
    }
    
      /* Ensure modals for "Bros who liked/disliked/met" appear properly */
      #metModal,
      #likesModal,
      #dislikesModal {
        z-index: 3000 !important;
      }
    
      .member-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }
    
      .member-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-gold);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        transition: var(--transition);
      }
    
      .member-card:hover .member-photo {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }
    
      .member-info h3 {
        color: var(--primary-gold);
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.01em;
      }
    
      /* Tier Badges */
      .tier-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
    
      .tier-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        transition: var(--transition);
      }
    
      .tier-badge.earned {
        opacity: 1;
        transform: scale(1);
      }
    
      .tier-badge.not-earned {
        opacity: 0.3;
        filter: grayscale(100%);
        transform: scale(0.95);
      }
    
      .tier-0 {
        background: linear-gradient(135deg, rgba(128, 128, 128, 0.3), rgba(128, 128, 128, 0.2));
        color: #ccc;
      }
    
      .tier-1 {
        background: linear-gradient(135deg, rgba(135, 206, 235, 0.3), rgba(135, 206, 235, 0.2));
        color: #87CEEB;
      }
    
      .tier-2 {
        background: linear-gradient(135deg, rgba(255, 20, 147, 0.3), rgba(255, 20, 147, 0.2));
        color: #FF1493;
      }
    
      .tier-3 {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.2));
        color: #FFD700;
      }
    
    .tier-4 {
      background: linear-gradient(
        135deg,
        rgba(0, 255, 68, 0.3),   /* bright green glow */
        rgba(0, 128, 0, 0.2)     /* darker green fade */
      );
      color: #00ff44; /* neon green */
    }
    
    
    
      .tier-flushed {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(139, 69, 19, 0.2));
        color: #CD853F;
      }
    
      /* Member Details */
      .member-details {
        margin-bottom: 20px;
        flex-shrink: 0;
      }
    
      .member-details p {
        margin-bottom: 8px;
        font-size: 15px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
    
      .member-details p:hover {
        color: var(--text-primary);
      }
    
      /* Member Actions */
      .member-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
        flex-shrink: 0;
      }
    
      .action-btn {
        background: rgba(255, 255, 255, 0.08);
        color: var(--primary-gold);
        border: 1px solid rgba(255, 215, 0, 0.3);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: var(--transition);
        white-space: nowrap;
      }
    
      .action-btn:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: var(--primary-gold);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
      }
    
      .action-btn.active-for-user {
        background: var(--primary-gold);
        color: #000;
        border-color: var(--primary-gold);
      }
    
      .action-btn.dislike.active-for-user {
        background: var(--error);
        color: white;
        border-color: var(--error);
      }
    
      .flush-btn {
        background: rgba(139, 69, 19, 0.2);
        color: #CD853F;
        border-color: #8B4513;
      }
    
      .flush-btn:hover {
        background: #8B4513;
        color: white;
      }
    
      /* Comments Section */
      .comments-section {
        margin-top: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 16px;
        padding: 16px;
      }
    
      .comments-section h4 {
        color: var(--primary-gold);
        font-size: 16px;
        margin-bottom: 12px;
        font-weight: 600;
      }
    
      .comments-list {
        flex: 1;
        overflow-y: auto;
        max-height: 180px;
        margin-bottom: 12px;
        padding-right: 8px;
      }
    
      /* Custom Scrollbar */
      .comments-list::-webkit-scrollbar {
        width: 6px;
      }
    
      .comments-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }
    
      .comments-list::-webkit-scrollbar-thumb {
        background: rgba(255, 215, 0, 0.3);
        border-radius: 3px;
      }
    
      .comments-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 215, 0, 0.5);
      }
    
      .comment {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 8px;
        font-size: 14px;
        position: relative;
        transition: var(--transition);
      }
    
      .comment:hover {
        background: rgba(255, 255, 255, 0.08);
      }
    
      .comment-author {
        color: var(--primary-gold);
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 13px;
      }
    
      .comment-text {
        color: var(--text-secondary);
        line-height: 1.5;
      }
    
      .comment-edit-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 215, 0, 0.2);
        color: var(--primary-gold);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        display: none;
        transition: var(--transition);
      }
    
      .comment:hover .comment-edit-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    
      .comment-edit-btn:hover {
        background: var(--primary-gold);
        color: #000;
      }

            /* Update/Replace existing comment button styles with these */
      .comment {
        position: relative;
      }

      .comment-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: none; /* Hidden by default */
        gap: 6px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 12px;
        padding: 2px;
      }

      .comment:hover .comment-actions {
        display: flex; /* Show on hover */
      }

      /* Ensure actions are visible on mobile without hover */
      @media (max-width: 768px) {
        .comment-actions {
          display: flex;
          background: transparent;
        }
      }

      .comment-action-btn {
        background: rgba(255, 215, 0, 0.2);
        color: var(--primary-gold);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .comment-action-btn:hover {
        background: var(--primary-gold);
        color: #000;
      }

      .comment-action-btn.delete-btn:hover {
        background: #ff4444; /* Red for delete */
        color: white;
      }
    
      /* Add Comment */
      .add-comment {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
      }
    
      .add-comment textarea {
        flex: 1;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 12px;
        padding: 10px 14px;
        color: var(--text-primary);
        resize: vertical;
        min-height: 44px;
        font-size: 14px;
        font-family: inherit;
        transition: var(--transition);
        -webkit-appearance: none;
      }
    
      .add-comment textarea:focus {
        outline: none;
        border-color: var(--primary-gold);
        background: rgba(255, 255, 255, 0.12);
      }
    
      .add-comment textarea::placeholder {
        color: var(--text-secondary);
      }
    
      .add-comment button {
        background: var(--primary-gold);
        color: #000;
        border: none;
        padding: 10px 20px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: var(--transition);
        white-space: nowrap;
      }
    
      .add-comment button:hover {
        background: var(--secondary-gold);
        transform: translateY(-1px);
      }
    
      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
    
      .modal-content {
        background: var(--bg-secondary);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 32px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
    
      .modal-content h2 {
        color: var(--primary-gold);
        margin-bottom: 24px;
        font-size: 24px;
        font-weight: 700;
      }
    
      /* Leaderboard Modal - wider to accommodate stats */
      .leaderboard-modal-content {
        max-width: 700px !important;
        max-height: 85vh;
        overflow-y: auto;
        /* Performance optimizations for smooth scrolling */
        -webkit-overflow-scrolling: touch;
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
      }
    
      .modal-header-leaderboard {
        margin-bottom: 1.5rem;
      }
    
      .modal-title-leaderboard {
        color: var(--primary-gold);
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
      }
    
      .leaderboard-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
      }
    
      .leaderboard-content {
        min-height: 200px;
      }
    
      .leaderboard-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(255, 215, 0, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 215, 0, 0.1);
      }
    
      .leaderboard-stat {
        text-align: center;
      }
    
      .leaderboard-stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-gold);
        display: block;
      }
    
      .leaderboard-stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
      }
    
      .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
    
      .leaderboard-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: var(--transition);
      }
    
      .leaderboard-item:hover {
        background: rgba(255, 215, 0, 0.05);
        border-color: var(--primary-gold);
      }
    
      /* Top 3 special styling */
      .leaderboard-item.rank-1 {
        border-color: var(--primary-gold);
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
      }
    
      .leaderboard-item.rank-2 {
        border-color: #C0C0C0;
        background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(192, 192, 192, 0.03) 100%);
      }
    
      .leaderboard-item.rank-3 {
        border-color: #CD7F32;
        background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(205, 127, 50, 0.03) 100%);
      }
    
      .leaderboard-rank {
        font-size: 1.5rem;
        font-weight: 700;
        min-width: 50px;
        text-align: center;
      }
    
      .rank-1 .leaderboard-rank {
        color: var(--primary-gold);
      }
    
      .rank-2 .leaderboard-rank {
        color: #C0C0C0;
      }
    
      .rank-3 .leaderboard-rank {
        color: #CD7F32;
      }
    
      .leaderboard-info {
        flex: 1;
        min-width: 0;
      }
    
      .leaderboard-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
      }
    
      .leaderboard-details {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
    
      .leaderboard-points {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-gold);
        min-width: 80px;
        text-align: right;
      }
    
      .badges-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
    
      /* Mobile responsiveness for leaderboard */
      @media (max-width: 768px) {
        .leaderboard-modal-content {
          max-width: 95vw !important;
          margin: 1rem;
          padding: 1.5rem 1rem;
        }
    
        .leaderboard-stats {
          grid-template-columns: repeat(3, 1fr);
          gap: 0.5rem;
          padding: 1rem;
          margin-bottom: 1.5rem;
        }
    
        .leaderboard-stat-value {
          font-size: 1.5rem;
        }
    
        .leaderboard-stat-label {
          font-size: 0.65rem;
        }
    
        .leaderboard-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
          padding: 0.75rem;
        }
    
        .leaderboard-rank {
          font-size: 1.2rem;
          min-width: auto;
          align-self: flex-start;
        }
    
        .leaderboard-info {
          width: 100%;
        }
    
        .leaderboard-name {
          font-size: 1rem;
        }
    
        .leaderboard-details {
          gap: 0.5rem;
          font-size: 0.8rem;
        }
    
        .leaderboard-points {
          font-size: 1.3rem;
          min-width: auto;
          text-align: left;
          align-self: flex-start;
        }
    
        .modal-title-leaderboard {
          font-size: 1.3rem;
        }
    
        .badges-container {
          gap: 0.4rem;
        }
    
        .badge {
          font-size: 0.7rem;
          padding: 0.2rem 0.5rem;
        }
    
        .badge-emoji {
          font-size: 0.9rem;
        }
      }
    
      @media (max-width: 480px) {
        .leaderboard-stats {
          grid-template-columns: 1fr;
          gap: 0.75rem;
        }
    
        .leaderboard-stat {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem;
          background: rgba(0, 0, 0, 0.2);
          border-radius: 8px;
        }
    
        .leaderboard-stat-value {
          font-size: 1.3rem;
          order: 2;
        }
    
        .leaderboard-stat-label {
          font-size: 0.75rem;
          text-align: left;
          order: 1;
        }
    
        .leaderboard-details {
          flex-direction: column;
          gap: 0.3rem;
        }
      }
    
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.6rem;
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.2);
        border-radius: 12px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
    
      .badge:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: rgba(255, 215, 0, 0.4);
        transform: scale(1.05);
      }
    
      .badge-tooltip {
        display: none;
        position: fixed;
        background: var(--bg-secondary);
        border: 2px solid var(--primary-gold);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        max-width: 300px;
        pointer-events: none;
      }
    
      .badge-tooltip.show {
        display: block;
      }
    
      .badge-tooltip-emoji {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
      }
    
      .badge-tooltip-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-gold);
        margin-bottom: 0.5rem;
      }
    
      .badge-tooltip-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }
    
      .badge-emoji {
        font-size: 0.9rem;
      }
    
      .no-data-message {
        text-align: center;
        color: var(--text-secondary);
        padding: 3rem 1rem;
        font-size: 1.1rem;
      }
    
      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }
    
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--primary-gold);
        font-weight: 600;
        font-size: 14px;
      }
    
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 12px;
        padding: 12px 16px;
        color: var(--text-primary);
        font-size: 15px;
        font-family: inherit;
        transition: var(--transition);
        -webkit-appearance: none;
      }
    
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary-gold);
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
      }
    
      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: var(--text-secondary);
      }
    
      .form-group select {
        min-height: 44px;
        cursor: pointer;
      }
    
      .form-group select#primaryContacts {
        min-height: 120px;
      }
    
      .form-group small {
        display: block;
        margin-top: 6px;
        color: var(--text-secondary);
        font-size: 13px;
      }
    
      /* Image Modal Styles */
      .image-modal {
        z-index: 2001 !important;
      }
    
      .image-modal-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    
      .image-modal-close {
        position: absolute;
        top: -40px;
        right: 0;
        color: var(--primary-gold);
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
        z-index: 2002;
        line-height: 1;
      }
    
      .image-modal-close:hover {
        color: #fff;
      }
    
      .enlarged-image {
        max-width: 90vw;
        max-height: 80vh;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        border: 2px solid var(--primary-gold);
      }
    
      .image-modal-caption {
        margin-top: 20px;
        color: var(--primary-gold);
        font-size: 20px;
        font-weight: 600;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      }
    
      @media (max-width: 768px) {
        .image-modal-close {
          top: -35px;
          font-size: 35px;
        }
    
        .enlarged-image {
          max-width: 95vw;
          max-height: 85vh;
        }
    
        .image-modal-caption {
          font-size: 18px;
          margin-top: 15px;
        }
      }
    
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 28px;
      }
    
      /* Loading Overlay */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 3000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 20px;
      }
    
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--primary-gold);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 0.8s linear infinite;
      }
    
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    
      .loading-overlay span {
        color: var(--primary-gold);
        font-size: 18px;
        font-weight: 600;
      }
    
      /* Error/Success Messages */
      .error-message {
        background-color: var(--error);
        color: white;
        padding: 14px 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        text-align: center;
        display: none;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
      }
    
    
      /* Animations */
      @keyframes shakeAnim {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-10px); }
        40%, 80% { transform: translateX(10px); }
      }
    
      .shake {
        animation: shakeAnim 0.5s ease-in-out;
      }
    
      @keyframes popAnim {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
    
      .pop {
        animation: popAnim 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }
    
      /* GIF Animations */
      .plunger-animation,
      .flush-animation,
      .demote-animation {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        pointer-events: none;
        z-index: 2000;
      }
    
      .plunger-animation {
        animation: plunger-in 1.s ease-out forwards;
      }
    
      @keyframes plunger-in {
        0% {
          opacity: 0;
          transform: translate(-50%, -100%) scale(0.5) rotate(-30deg);
        }
        40% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1) rotate(0deg);
        }
        80% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5) rotate(30deg);
        }
      }
    
      /* Skeleton Loaders for Virtual Scrolling */
      .skeleton-loader {
        display: flex;
        gap: 20px;
        padding: 20px;
        animation: pulse 1.5s ease-in-out infinite;
      }
    
      @keyframes pulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 0.4; }
      }
    
      .skeleton-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.05) 25%,
          rgba(255, 215, 0, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        flex-shrink: 0;
      }
    
      .skeleton-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        justify-content: center;
      }
    
      .skeleton-line {
        height: 16px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.05) 25%,
          rgba(255, 215, 0, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
      }
    
      .skeleton-line-title {
        width: 60%;
        height: 24px;
      }
    
      .skeleton-line-short {
        width: 40%;
      }
    
      .skeleton-line-medium {
        width: 80%;
      }
    
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
    
    
      /* Utility Classes */
      .hidden {
        display: none !important;
      }
    
      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 15px;
        }
    
        .header h1 {
          font-size: 2rem;
        }
    
        .search-container {
          flex: 0 1 auto;
          max-width: 100%;
        }
    
        .members-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }
    
        .member-card {
          min-height: auto;
        }
    
        .modal-content {
          padding: 24px;
          margin: 20px;
        }
    
        .sse-status {
          top: 10px;
          right: 10px;
          font-size: 11px;
          padding: 6px 12px;
        }
      }
    
      /* Safari-specific fixes */
      @supports (-webkit-touch-callout: none) {
        .btn,
        .action-btn,
        .sort-btn {
          -webkit-tap-highlight-color: transparent;
        }
    
        .member-card,
        .modal-content {
          -webkit-transform: translateZ(0);
          transform: translateZ(0);
        }
      }
    
      /* Fix for iOS input zoom */
      @media screen and (max-width: 768px) {
        input,
        textarea,
        select {
          font-size: 16px !important;
        }
      }
    
      /* Styles for the new swipe-up drawer on mobile */
    @media (max-width: 768px) {
      /* Hide the original floating button on mobile, as the drawer replaces it */
      .controls-wrapper {
        display: none !important;
      }
    }
    
    @media (max-width: 768px) {
      .member-card,
      .controls-panel,
      .top-bar,
      .modal,
      .loading-overlay,
      .tier-badge {
        -webkit-backdrop-filter: none;
        backdrop-filter: none;
      }
    
      /* Optional: Use a slightly more opaque background to compensate */
      .member-card {
        background: rgba(255, 255, 255, 0.08);
      }
    
      /* The main container for the drawer */
      .drawer-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 200;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.4);
        /* Start with only 50px visible at the bottom as an affordance */
        transform: translateY(calc(100% - 50px));
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
        padding-top: 20px; /* Space for the handle */
        touch-action: none; /* Prevents page scroll while dragging drawer */
      }
    
      .drawer-container.open {
        transform: translateY(0);
      }
    
      /* The grab handle visual cue */
      .drawer-handle {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 5px;
        background-color: rgba(255, 215, 0, 0.5);
        border-radius: 3px;
        transition: background-color 0.2s ease;
      }
    
      .drawer-container.open .drawer-handle {
        background-color: rgba(255, 215, 0, 0.7);
      }
    
      /* Re-style the controls panel to fit inside the new drawer */
      #controlsPanel {
        max-height: 75vh; /* Improved height for better usability */
        overflow-y: auto;
        overflow-x: hidden;
        padding: 10px;
        border-radius: 0;
        box-shadow: none;
        border: none;
        background: transparent;
        position: relative !important; /* Override inline styles */
        top: auto !important;
        right: auto !important;
        left: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 215, 0, 0.3) transparent;
      }
    
      /* Custom scrollbar for webkit browsers */
      #controlsPanel::-webkit-scrollbar {
        width: 6px;
      }
    
      #controlsPanel::-webkit-scrollbar-track {
        background: transparent;
      }
    
      #controlsPanel::-webkit-scrollbar-thumb {
        background: rgba(255, 215, 0, 0.3);
        border-radius: 3px;
      }
    
      #controlsPanel::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 215, 0, 0.5);
      }
    
      /* Overlay to close the drawer on tap */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 199;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
      }
    
      .drawer-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }
    
      /* Mobile-friendly improvements for controls */
      .controls-panel h3 {
        font-size: 20px;
        margin-bottom: 16px;
      }
    
      .controls-panel h4 {
        font-size: 16px;
        margin-bottom: 12px;
      }
    
      .controls-section {
        margin-bottom: 24px;
      }
    
      .quick-action-btn {
        padding: 16px 20px;
        font-size: 16px;
        min-height: 52px;
        border-radius: 14px;
        gap: 12px;
      }
    
      .quick-action-btn span {
        font-size: 20px;
      }
    
      /* Better touch feedback */
      .quick-action-btn:active {
        transform: scale(0.98);
        background: rgba(255, 215, 0, 0.25);
      }
    
      .quick-actions {
        gap: 14px;
      }
    
      /* Stats display improvements */
      .stats-display {
        gap: 14px;
      }
    
      .stat-item {
        padding: 14px;
      }
    
      .stat-label {
        font-size: 13px;
      }
    
      .stat-value {
        font-size: 18px;
        font-weight: 600;
      }
    
      /* Better visual hierarchy */
      #controlsPanel {
        padding: 16px;
        padding-bottom: 24px; /* Extra padding at bottom for easier scrolling */
      }
    
      /* Ensure last section has enough bottom padding */
      .controls-section:last-child {
        padding-bottom: 20px;
      }
    }
    #activeUsersDisplay {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;       /* single line */
      overflow-x: auto;          /* horizontal scroll */
      overflow-y: hidden;
      max-width: 100%;
      padding-bottom: 2px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    /* --- RHO ADMIN CONSOLE STYLES --- */
.rho-admin-btn {
  background: linear-gradient(135deg, #FF416C, #FF4B2B); /* Distinct Red/Orange for Admin */
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.rho-admin-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6);
}

.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  margin-bottom: 15px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.setting-info h4 {
  color: var(--primary-gold);
  margin-bottom: 5px;
}

.setting-info p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin: 0;
}

    /* iOS Style Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.2);
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-gold);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    #activeUsersDisplay::after { content: attr(data-empty); }
    
    #activeUsersDisplay span {
      background: rgba(255,255,255,.08);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      flex: 0 0 auto;            /* chips don‚Äôt shrink */
    }
    
    .you-chip { background: var(--primary-gold); color: #000; border: 1px solid var(--primary-gold); }
    
    .comment-meta {
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.85;
      margin-top: 2px;
    }
    
    /* Show/hide per device */
    .only-desktop { display: none; }
    .only-mobile  { display: none; }
    
    @media (min-width: 769px) {
      .only-desktop { display: inline; }
    }
    @media (max-width: 768px) {
      .only-mobile { display: inline; }
    }
    
    /* Enhanced empty state styles */
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      min-height: 50vh;
      text-align: center;
      padding: 60px 20px;
      border: 2px dashed var(--border-color);
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    /* Subtle animated background */
    .empty-state::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, 
        rgba(255, 215, 0, 0.05) 0%, 
        transparent 70%);
      animation: emptyStateGlow 8s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes emptyStateGlow {
      0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
      50% { transform: translate(10px, -10px) scale(1.1); opacity: 1; }
    }
    
    .empty-state h3 {
      color: var(--primary-gold);
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.02em;
    }
    
    .empty-state p {
      color: var(--text-secondary);
      max-width: 520px;
      line-height: 1.6;
      margin: 0;
    }
    
    .empty-state p strong {
      color: var(--text-primary);
    }
    
    .empty-state .btn,
    .empty-state .cancel-btn {
      margin-top: 10px;
    }
    
    /* Icon animation for empty state */
    .empty-state h3::before {
      content: attr(data-icon);
      display: block;
      font-size: 3rem;
      margin-bottom: 15px;
      animation: iconBounce 2s ease-in-out infinite;
    }
    
    @keyframes iconBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .empty-state {
        min-height: 40vh;
        padding: 40px 20px;
      }
      
      .empty-state h3 {
        font-size: 1.25rem;
      }
      
      .empty-state h3::before {
        font-size: 2.5rem;
      }
    }
    
    /* Grid-wide empty state positioning */
    .members-grid .empty-state {
      grid-column: 1 / -1;
      max-width: 640px;
      margin: 40px auto;
    }
    
      </style>
    </head>
    <body>
    
    <div id="tsparticles" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;"></div>
    
    <div class="sse-status disconnected" id="sseStatus">
      <span class="sse-status-dot"></span>
      <span id="sseStatusText">Disconnected</span>
    </div>
    
    <div id="mainApp" class="hidden">
      <div class="header">
        <h1>üèõÔ∏è PKS Rush Management</h1>
      </div>
    
                  <div class="rush-event-header">
                    <h2 id="rushEventName"></h2>
                    <a href="#" id="backToArchives" class="back-to-archives-btn" style="display: none;">Back to Archives</a>
                  </div>
            
                  <!-- Quick Controls Section -->
                  <div class="quick-controls">
                    <button id="adminMenuBtn" class="admin-menu-btn" style="display: none;" onclick="toggleAdminMenu()">Admin</button>
                  </div>            <div id="adminMenu" class="admin-menu" style="display: none;">
                <h3>Admin Controls</h3>
                <div class="admin-option">
                    <label for="globalDisableAddRecruits">Globally Disable Adding Recruits</label>
                    <input type="checkbox" id="globalDisableAddRecruits" onchange="setGlobalAddRecruits(this.checked)">
                </div>
                <div class="admin-option">
                    <label for="globalDisableCommenting">Globally Disable Commenting</label>
                    <input type="checkbox" id="globalDisableCommenting" onchange="setGlobalCommenting(this.checked)">
                </div>
        
                <div class="admin-option-group">
                    <h4>Per-Brother Controls</h4>
                    <select id="selectBrotherToManage" onchange="loadBrotherSettings()">
                        <option value="">Select a brother...</option>
                    </select>
                    <div id="brotherSpecificControls" style="display: none;">
                        <div class="admin-option">
                            <label for="disableBrotherCommenting">Disable Commenting for Selected Brother</label>
                            <input type="checkbox" id="disableBrotherCommenting" onchange="setBrotherCommenting(this.checked)">
                        </div>
                        <div class="admin-option">
                            <label for="disableBrotherInteractions">Disable Interactions for Selected Brother</label>
                            <input type="checkbox" id="disableBrotherInteractions" onchange="setBrotherInteractions(this.checked)">
                        </div>
                        <button onclick="saveBrotherSettings()">Save Brother Settings</button>
                    </div>
                </div>
            </div>    
      <!-- Locked Banner (shown when rush is locked) -->
      <div id="lockedBanner" class="locked-banner" style="display: none;">
        <div class="locked-banner-content">
          <span class="locked-icon">üîí</span>
          <div class="locked-text">
            <strong>View-Only Mode</strong>
            <p>This rush event has been archived and locked. Editing is disabled to preserve historical records.</p>
          </div>
        </div>
      </div>
    
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <a href="#" data-page="rusharchives" class="back-to-archives-btn">‚Üê Back to Rush Archives</a>
      </div>
    
      <div class="top-bar">
      <!-- SSE Refresh Button -->
      <button class="sse-refresh-btn" id="sseRefreshBtn" onclick="forceSSERefresh()" title="Force refresh data">
        ‚Üª
      </button>
      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Search recruits‚Ä¶"
        />
        <button class="clear-search-btn hidden" id="clearSearchBtn">&times;</button>
      </div>
      <div class="top-bar-buttons" style="display: flex; gap: 8px;">
        <button class="top-rushers-btn" onclick="showLeaderboardOnRushPage()" title="View engagement leaderboard">
          üèÜ Top Rushers
        </button>
        <button id="rhoAdminBtn" class="rho-admin-btn" onclick="openRhoSettings()" style="display: none;">
          üõ°Ô∏è Rho Admin
        </button>
        <button id="allScoresBtn" class="top-rushers-btn" onclick="showAllScores()" title="View all brother scores" style="display: none; background: linear-gradient(45deg, #FF6B6B, #FF8E53);">
          üìä All Scores
        </button>
      </div>
    </div>
    
    <div class="controls-wrapper">
      <button class="controls-toggle" id="controlsToggle">
        <span>+</span>
      </button>
      
      <div class="controls-panel" id="controlsPanel">
        <h3>Quick Controls</h3>
        
        <div class="controls-section">
          <div class="stats-display">
            <div class="stat-item">
              <span class="stat-label">Total Recruits:</span>
              <span class="stat-value" id="totalRecruits">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Filter:</span>
              <span class="stat-value" id="currentFilterDisplay">All</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Active Users:</span>
              <span class="stat-value" id="activeUsersDisplay">‚Äì</span>
            </div>
          </div>
        </div>
        
        <div class="controls-section">
          <div class="quick-actions">
            <button class="quick-action-btn" onclick="openAddModal()">
              <span>‚ûï</span> Add New Member
            </button>
          </div>
        </div>
    
    
        <div class="controls-section">
          <h4 style="color: var(--primary-gold); font-size: 16px; margin-bottom: 10px;">Filter by Tier</h4>
          <div class="quick-actions">
            <button class="quick-action-btn" onclick="sortMembers('all')">
              <span>üë•</span> Show All
            </button>
            <button class="quick-action-btn" onclick="sortMembers('tier0')">
              <span>üë§</span> Tier 0 - Initial
            </button>
            <button class="quick-action-btn" onclick="sortMembers('tier1')">
              <span>üö¢</span> Tier 1 - Boat Cruise
            </button>
            <button class="quick-action-btn" onclick="sortMembers('tier2')">
              <span>ü¶û</span> Tier 2 - Steak & Lobster
            </button>
            <button class="quick-action-btn" onclick="sortMembers('tier3')">
              <span>üéØ</span> Tier 3 - Bid Dinner
            </button>
            <button class="quick-action-btn" onclick="sortMembers('tier4')">
              <span>‚úâÔ∏è</span> Tier 4 - Bid
            </button>
            <button class="quick-action-btn" onclick="sortMembers('flushed')">
              <span>üöΩ</span> Flushed
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="rhoSettingsModal">
      <div class="modal-content" style="max-width: 500px;">
        <h2>üõ°Ô∏è Rho Control Panel</h2>
        
        <div class="setting-row">
          <div class="setting-info">
            <h4>Allow Recruit Addition</h4>
            <p>If disabled, only Rhos can add new recruits. Others are blocked.</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="toggleAddRecruits" checked onchange="updateRhoSetting('allowAdds', this.checked)">
            <span class="slider"></span>
          </label>
        </div>
    
        <div class="setting-row">
          <div class="setting-info">
            <h4>Anti-Spam Mode</h4>
            <p>Enforces a 5-second cooldown between comments and likes for everyone.</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="toggleSpamProtection" onchange="updateRhoSetting('spamProtection', this.checked)">
            <span class="slider"></span>
          </label>
        </div>
    
        <div class="setting-row">
          <div class="setting-info">
            <h4>Lock Rush Event</h4>
            <p>Read-only mode for archives (Current status: <span id="lockStatusText">Active</span>)</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="toggleGlobalLock" onchange="toggleFullRushLock(this.checked)">
            <span class="slider"></span>
          </label>
        </div>
    
        <div class="form-actions">
          <button class="btn" onclick="document.getElementById('rhoSettingsModal').style.display='none'">Close</button>
        </div>
      </div>
    </div>
    
      <div class="error-message" id="errorMessage"></div>
    
      <div class="members-grid" id="membersGrid"></div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>
    
    <div class="modal" id="memberModal">
      <div class="modal-content">
        <h2 id="modalTitle">Add New Member</h2>
        <form id="memberForm">
          <div class="form-group">
            <label for="memberName">Name *</label>
            <input type="text" id="memberName" required>
          </div>
          <div class="form-group">
            <label for="memberPhotoFile">Upload Photo</label>
            <input type="file" id="memberPhotoFile" accept="image/*">
            <small>Upload an image file (PNG, JPG, GIF, HEIC, etc.)</small>
          </div>
          <div class="form-group">
            <label for="memberEmail">Email</label>
            <input type="email" id="memberEmail">
          </div>
          <div class="form-group">
            <label for="memberPhone">Phone</label>
            <input type="tel" id="memberPhone">
          </div>
          <div class="form-group">
            <label for="memberInstagram">Instagram</label>
            <input type="text" id="memberInstagram" placeholder="@username">
          </div>
          <div class="form-group" id="primaryContactsGroup">
            <label for="primaryContacts">Primary Contact Brothers</label>
            <select id="primaryContacts" multiple>
            </select>
            <small>Hold Ctrl/Cmd to select multiple brothers</small>
          </div>
          <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="requestCloseModal()">Cancel</button>
            <button type="submit" class="btn">Save Member</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Leaderboard Modal -->
    <div class="modal" id="leaderboardModal">
      <div class="modal-content leaderboard-modal-content">
        <div class="modal-header-leaderboard">
          <h2 class="modal-title-leaderboard">üèÜ Top Rushers</h2>
          <p class="leaderboard-subtitle" id="leaderboardSubtitle"></p>
        </div>
        <div id="leaderboardContent" class="leaderboard-content">
          <div class="spinner"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeLeaderboardOnRushPage()">Close</button>
        </div>
      </div>
    </div>
    
    <!-- Badge Tooltip -->
    <div class="badge-tooltip" id="badgeTooltip">
      <span class="badge-tooltip-emoji" id="badgeTooltipEmoji"></span>
      <div class="badge-tooltip-name" id="badgeTooltipName"></div>
      <div class="badge-tooltip-description" id="badgeTooltipDescription"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
    // Global variables
    var members = [];
    var currentFilter = 'all';
    var editingMemberId = null;
    var currentUser = '<%- name %>'; // User's display name for UI
    var currentUserEmail = '<%- email %>'; // User's email for validation
    var rushId = '<%- rushId %>';
    var contacts = <%- JSON.stringify(contacts) || '[]' %>;
    // Use template-provided sessionId (works both standalone and when dynamically loaded)
    // When dynamically loaded, the parent's SESSION_ID is used via home.html's call to getRushPageView
    var RUSH_SESSION_ID = '<%- sessionId %>';
    // Fallback to parent scope SESSION_ID only if template value is empty (shouldn't happen in production)
    if (!RUSH_SESSION_ID && typeof SESSION_ID !== 'undefined') {
      RUSH_SESSION_ID = SESSION_ID;
    }
    console.log('Rush Page - RUSH_SESSION_ID:', RUSH_SESSION_ID ? 'SET' : 'EMPTY', '(length:', RUSH_SESSION_ID ? RUSH_SESSION_ID.length : 0, ')');
    // stateManager is already defined in the first script block
    var position = '<%- position %>';
    var BASE_URL = '<%- baseUrl %>';
    var isLocked = <%- (typeof isLocked !== 'undefined' && isLocked) ? 'true' : 'false' %>; // Rush page lock status
    var SSE_URL = '<%= baseUrl %>';
    
    var searchTerm = '';
    var currentRushEvent = null;
    var eventSource = null;
    var reconnectTimeout = null;
    var reconnectAttempts = 0;
    var maxReconnectAttempts = 10;
    var reconnectDelay = 1000;
    var cardIdToScrollTo = null;
    var controlsOpen = false;
    var activeUsers = [];
    
    // --- helpers for Active Users ---
    function dedupeActiveUsers(arr) {
      // trim, drop falsy, and unique by exact match
      const cleaned = arr
        .map(v => (v == null ? '' : String(v).trim()))
        .filter(Boolean);
      return Array.from(new Set(cleaned));
    }
    
    // Toggle this to disable the test names later
    var DEBUG_ADD_FAKE_ACTIVE_USERS = false;
    
    // 30 fake names to stress‚Äëtest the UI
    var FAKE_ACTIVE_NAMES = [
      "Avery Brooks","Jordan Lee","Taylor Morgan","Quinn Parker","Riley James",
      "Casey Rivera","Alex Kim","Jamie Patel","Cameron Diaz","Drew Carter",
      "Morgan Blake","Shawn Turner","Reese Collins","Rowan Scott","Sydney Hayes",
      "Parker Nguyen","Devin Bennett","Kendall Ross","Skyler Brooks","Harper Lane",
      "Logan Price","Payton Murphy","Dakota Reed","Sage Coleman","Charlie Watts",
      "Elliot Clarke","Emerson Shaw","Finley Howard","Jules Barrett","Robin West"
    ];
    
    // Performance optimization: throttle render updates
    var isRendering = false;
    var pendingRender = false;
    var isControlsInitialized = false;
    
    // Add this function before initializeControlsPanel
    function cleanupControlsPanel() {
      // Reset the initialization flag
      isControlsInitialized = false;
      
      // Remove existing event listeners by cloning and replacing elements
      const toggle = document.getElementById('controlsToggle');
      const panel = document.getElementById('controlsPanel');
      
      if (toggle) {
        const newToggle = toggle.cloneNode(true);
        toggle.parentNode.replaceChild(newToggle, toggle);
      }
      
      // Reset the controls state
      controlsOpen = false;
      if (panel) {
        panel.classList.remove('open');
      }
      
      // Reset the original parent reference
      controlsPanelOriginalParent = null;
    }
    
    // Initialize controls panel
    function initializeControlsPanel() {
      // --- ADD THESE THREE LINES ---
      cleanupControlsPanel();
      if (isControlsInitialized) {
        return; // Do nothing if already initialized
      }
      isControlsInitialized = true;
      // -----------------------------
      const toggle = document.getElementById('controlsToggle');
      const panel = document.getElementById('controlsPanel');
    
      panel.addEventListener('wheel', e => e.stopPropagation(), { passive: true });
      panel.addEventListener('touchmove', e => e.stopPropagation(), { passive: true });
      
      if (!toggle || !panel) return;
    
       if (window.innerWidth > 768) {
        panel.style.visibility = '';
        panel.style.opacity = '';
      }
      
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        console.log('[CTRL] click!  controlsOpen was', controlsOpen);
        controlsOpen = !controlsOpen;
        toggle.classList.toggle('active');
        panel.classList.toggle('open');
      });
      
      // Close panel when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.controls-wrapper') && controlsOpen) {
          controlsOpen = false;
          toggle.classList.remove('active');
          panel.classList.remove('open');
        }
      });
      
      // Update stats
      updateControlsStats();
    }
    
    function renderActiveUsers() {
      const el = document.getElementById('activeUsersDisplay');
      if (!el) return;
    
      const you = activeUsers.filter(u => u === currentUser);
      const others = activeUsers.filter(u => u !== currentUser);
      const names = [...you.map(() => 'you'), ...others];
    
      el.innerHTML = '';
      if (!names.length) {
        el.setAttribute('data-empty', '‚Äì');
        return;
      }
      el.removeAttribute('data-empty');
    
      names.forEach(name => {
        const chip = document.createElement('span');
        chip.textContent = name;
        if (name === 'you') chip.classList.add('you-chip');
        el.appendChild(chip);
      });
    }
    
    
    
    // Update stats in the controls panel
    function updateControlsStats() {
      const totalRecruits = document.getElementById('totalRecruits');
      const currentFilterDisplay = document.getElementById('currentFilterDisplay');
      
      if (totalRecruits) {
        const filteredCount = getFilteredMembers().length;
        const totalCount = members.length;
        totalRecruits.textContent = currentFilter === 'all' ? 
          totalCount : 
          `${filteredCount} / ${totalCount}`;
      }
      
      if (currentFilterDisplay) {
        const filterNames = {
          'all': 'All',
          'tier0': 'Tier 0',
          'tier1': 'Boat Cruise',
          'tier2': 'Steak & Lobster',
          'tier3': 'Bid Dinner',
          'tier4': 'Bid',
          'flushed': 'Flushed'
        };
        currentFilterDisplay.textContent = filterNames[currentFilter] || 'All';
      }
      renderActiveUsers();
    }
    
    // This variable will remember the original location of the controls panel
    var controlsPanelOriginalParent = window.controlsPanelOriginalParent || null;
    
    function teardownSwipeControls() {
      const mobileDrawer = document.getElementById('mobileDrawer');
      const overlay = document.getElementById('drawerOverlay');
      const controlsPanel = document.getElementById('controlsPanel');
    
      // If the panel and its original home exist, put it back
      if (controlsPanel && controlsPanelOriginalParent) {
        // Restore original styles needed for PC view
        controlsPanel.style.position = '';
        controlsPanel.style.transform = '';
        controlsPanel.style.maxWidth = '';
        controlsPanel.style.width = '';
        controlsPanel.style.height = '';
        controlsPanel.style.overflow = '';
        controlsPanel.style.padding = '';
        controlsPanel.style.background = '';
        controlsPanel.style.border = '';
        controlsPanel.style.boxShadow = '';
        controlsPanel.style.display = '';
        controlsPanel.style.opacity = '';
        controlsPanelOriginalParent.appendChild(controlsPanel);
      }
    
      // Remove the mobile-only elements
      if (mobileDrawer) mobileDrawer.remove();
      if (overlay) overlay.remove();
    
      // Make sure the desktop wrapper is visible
      const desktopWrapper = document.querySelector('.controls-wrapper');
      if (desktopWrapper) {
        desktopWrapper.style.display = ''; // Use empty string to revert to CSS default
      }
    
      // Also ensure the panel has the correct classes
      const panel = document.getElementById('controlsPanel');
      if (panel) {
        panel.classList.remove('open'); // Reset the open state
      }
    }
    
    function setupSwipeUpControls() {
      // If we are on a PC-sized screen, tear down any mobile UI and exit.
      if (window.innerWidth > 768) {
        teardownSwipeControls();
        return;
      }
    
      // If the mobile drawer is already built, do nothing.
      if (document.getElementById('mobileDrawer')) return;
    
      const controlsPanel = document.getElementById('controlsPanel');
      if (!controlsPanel) return;
    
      // Remember original parent
      if (!controlsPanelOriginalParent) {
        controlsPanelOriginalParent = controlsPanel.parentElement;
      }
    
      // Create drawer container
      const drawerContainer = document.createElement('div');
      drawerContainer.id = 'mobileDrawer';
      drawerContainer.className = 'drawer-container';
    
      // Create handle
      const drawerHandle = document.createElement('div');
      drawerHandle.className = 'drawer-handle';
      drawerContainer.appendChild(drawerHandle);
    
      // Create overlay
      const overlay = document.createElement('div');
      overlay.id = 'drawerOverlay';
      overlay.className = 'drawer-overlay';
    
      // Move the panel into the drawer
      drawerContainer.appendChild(controlsPanel);
    
      // Make sure the panel is visible
      controlsPanel.style.display = 'block';
      controlsPanel.style.opacity = '1';
    
      // Add to DOM
      document.body.appendChild(drawerContainer);
      document.body.appendChild(overlay);
    
      // Touch handling variables
      let startY = 0;
      let currentY = 0;
      let startTime = 0;
      let isDragging = false;
      let containerHeight = 0;
      let isOpen = false;
      let currentTranslateY = 0;
      let lastVelocity = 0;
    
      // Constants for better feel
      const SWIPE_THRESHOLD = 50; // pixels
      const VELOCITY_THRESHOLD = 0.5; // pixels per ms
      const RUBBER_BAND_FACTOR = 0.3; // resistance when over-dragging
      const CLOSED_POSITION = 50; // pixels visible when closed
    
      // Get drawer height
      function updateDrawerHeight() {
        containerHeight = drawerContainer.offsetHeight;
      }
    
      // Calculate the translation based on open/closed state
      function getTargetTranslateY(open) {
        return open ? 0 : containerHeight - CLOSED_POSITION;
      }
    
      // Apply transform with hardware acceleration
      function setTransform(translateY, transition = false) {
        currentTranslateY = translateY;
        if (transition) {
          drawerContainer.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        } else {
          drawerContainer.style.transition = 'none';
        }
        drawerContainer.style.transform = `translate3d(0, ${translateY}px, 0)`;
      }
    
      // Initialize position
      updateDrawerHeight();
      setTransform(getTargetTranslateY(false));
    
      // Open drawer
      function openDrawer() {
        isOpen = true;
        drawerContainer.classList.add('open');
        overlay.classList.add('visible');
        setTransform(0, true);
      }
    
      // Close drawer
      function closeDrawer() {
        isOpen = false;
        drawerContainer.classList.remove('open');
        overlay.classList.remove('visible');
        setTransform(getTargetTranslateY(false), true);
      }
    
      // Toggle drawer
      function toggleDrawer() {
        if (isOpen) {
          closeDrawer();
        } else {
          openDrawer();
        }
      }
    
      // Touch/Mouse start
      function handleStart(clientY) {
        isDragging = true;
        startY = clientY;
        currentY = clientY;
        startTime = Date.now();
        lastVelocity = 0;
        updateDrawerHeight();
        drawerContainer.style.transition = 'none';
      }
    
      // Touch/Mouse move
      function handleMove(clientY) {
        if (!isDragging) return;
        
        const deltaY = clientY - startY;
        const deltaTime = Date.now() - startTime;
        
        // Calculate velocity for momentum
        if (deltaTime > 0) {
          lastVelocity = (clientY - currentY) / deltaTime;
        }
        currentY = clientY;
        
        let newTranslateY;
        
        if (isOpen) {
          // When open, dragging down closes it
          if (deltaY > 0) {
            // Apply rubber band effect if trying to drag beyond closed position
            if (deltaY > containerHeight - CLOSED_POSITION) {
              const excess = deltaY - (containerHeight - CLOSED_POSITION);
              newTranslateY = (containerHeight - CLOSED_POSITION) + (excess * RUBBER_BAND_FACTOR);
            } else {
              newTranslateY = deltaY;
            }
          } else {
            // Rubber band when trying to drag up beyond open
            newTranslateY = deltaY * RUBBER_BAND_FACTOR;
          }
        } else {
          // When closed, dragging up opens it
          if (deltaY < 0) {
            const basePosition = containerHeight - CLOSED_POSITION;
            newTranslateY = Math.max(0, basePosition + deltaY);
          } else {
            // Rubber band when trying to drag down beyond closed
            const basePosition = containerHeight - CLOSED_POSITION;
            newTranslateY = basePosition + (deltaY * RUBBER_BAND_FACTOR);
          }
        }
        
        setTransform(newTranslateY);
      }
    
      // Touch/Mouse end
      function handleEnd() {
        if (!isDragging) return;
        isDragging = false;
        
        const deltaY = currentY - startY;
        const deltaTime = Date.now() - startTime;
        const velocity = deltaTime > 0 ? Math.abs(deltaY) / deltaTime : 0;
        
        // Determine if we should open or close based on position, velocity, and direction
        let shouldOpen;
        
        if (isOpen) {
          // Currently open - check if we should close
          const draggedDistance = Math.abs(deltaY);
          const draggedPercent = draggedDistance / containerHeight;
          
          shouldOpen = !(
            draggedDistance > SWIPE_THRESHOLD || 
            velocity > VELOCITY_THRESHOLD || 
            draggedPercent > 0.3 ||
            (lastVelocity > VELOCITY_THRESHOLD && deltaY > 0)
          );
        } else {
          // Currently closed - check if we should open
          const draggedDistance = Math.abs(deltaY);
          const draggedPercent = draggedDistance / containerHeight;
          
          shouldOpen = (
            draggedDistance > SWIPE_THRESHOLD || 
            velocity > VELOCITY_THRESHOLD || 
            draggedPercent > 0.3 ||
            (Math.abs(lastVelocity) > VELOCITY_THRESHOLD && deltaY < 0)
          ) && deltaY < 0;
        }
        
        if (shouldOpen) {
          openDrawer();
        } else {
          closeDrawer();
        }
      }
    
      // Touch events
      drawerContainer.addEventListener('touchstart', (e) => {
        if (e.target === drawerHandle || (!isOpen && e.target === drawerContainer)) {
          handleStart(e.touches[0].clientY);
          e.preventDefault();
        }
      });
    
      drawerContainer.addEventListener('touchmove', (e) => {
        if (isDragging) {
          handleMove(e.touches[0].clientY);
          e.preventDefault();
        }
      });
    
      drawerContainer.addEventListener('touchend', handleEnd);
      drawerContainer.addEventListener('touchcancel', handleEnd);
    
      // Mouse events for testing on desktop
      drawerContainer.addEventListener('mousedown', (e) => {
        if (e.target === drawerHandle || (!isOpen && e.target === drawerContainer)) {
          handleStart(e.clientY);
          e.preventDefault();
        }
      });
    
      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          handleMove(e.clientY);
          e.preventDefault();
        }
      });
    
      document.addEventListener('mouseup', handleEnd);
    
      // Click to open when closed
      drawerContainer.addEventListener('click', (e) => {
        if (!isDragging && !isOpen && 
            (e.target === drawerContainer || e.target === drawerHandle)) {
          openDrawer();
        }
      });
    
      // Close on overlay click
      overlay.addEventListener('click', closeDrawer);
    
      // Handle window resize
      window.addEventListener('resize', () => {
        updateDrawerHeight();
        if (!isDragging) {
          setTransform(getTargetTranslateY(isOpen));
        }
      });
    }
    
    // Note: stateManager is already defined globally at the top of the page
    
    // Track UI state to prevent interruptions
    var uiState = {
      isEditingComment: false,
      isInModal: false,
      isInSearch: false,          
      activeCommentTextarea: null,
      modalFormData: null,
      updatePending: false,
      updateDeferTimeout: null
    };
    
    // Force SSE Refresh - triggered by refresh button
    function forceSSERefresh() {
      const btn = document.getElementById('sseRefreshBtn');
      if (btn) {
        btn.classList.add('spinning');
      }
      console.log('Force refreshing SSE connection and data...');
      
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      loadMembersAndComments(); 
    
      // Since loadMembersAndComments doesn't return a Promise in your code, 
      // we handle the button animation separately
      setTimeout(() => {
        if (btn) btn.classList.remove('spinning');
        console.log('Data refreshed successfully');
      }, 1000);
    
      setTimeout(() => {
        connectSSE();
      }, 100);
    }

    // SSE Connection Management
    function connectSSE() {
      if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        return;
      }
    
      updateSSEStatus('reconnecting');
      
      try {
        eventSource = new EventSource(
      `${SSE_URL}/sse?user=${encodeURIComponent(currentUser)}`
    );
        
        eventSource.onopen = function() {
          console.log('SSE connection established');
          updateSSEStatus('connected');
          reconnectAttempts = 0;
          reconnectDelay = 1000;
        };
        
        eventSource.onmessage = function(event) {
          try {
            var data = JSON.parse(event.data);
            if (data.refresh) {
              console.log('Received refresh signal via SSE');
              handleRealtimeUpdate();
            }
            if (Array.isArray(data.activeUsers)) {
              let incoming = data.activeUsers;
              if (DEBUG_ADD_FAKE_ACTIVE_USERS) {
                incoming = incoming.concat(FAKE_ACTIVE_NAMES);
              }
              activeUsers = dedupeActiveUsers(incoming);
              renderActiveUsers();
            }
          } catch (e) {
            console.error('Error parsing SSE message:', e);
          }
        };
        
        eventSource.onerror = function(error) {
          console.error('SSE connection error:', error);
          updateSSEStatus('disconnected');
          eventSource.close();
          
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectTimeout = setTimeout(function() {
              reconnectAttempts++;
              reconnectDelay = Math.min(reconnectDelay * 2, 30000);
              connectSSE();
            }, reconnectDelay);
          }
        };
      } catch (error) {
        console.error('Failed to create SSE connection:', error);
        updateSSEStatus('disconnected');
      }
    }
    
    function disconnectSSE() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
      }
      updateSSEStatus('disconnected');
    }
    
    function updateSSEStatus(status) {
      var statusElement = document.getElementById('sseStatus');
      var statusText = document.getElementById('sseStatusText');
      
      if (statusElement && statusText) {
        statusElement.className = 'sse-status ' + status;
        
        switch(status) {
          case 'connected':
            statusText.textContent = 'Live';
            break;
          case 'disconnected':
            statusText.textContent = 'Disconnected';
            break;
          case 'reconnecting':
            statusText.textContent = 'Reconnecting...';
            break;
          case 'stale':
            statusText.textContent = 'Refresh Pending';
            break;
        }
      }
    }
    
    // Enhanced real-time update handler
    function handleRealtimeUpdate() {
      // Clean up old operations first
      stateManager.cleanupOldOperations();
      
      // If user is actively editing, defer the update
      if (uiState.isEditingComment || uiState.isInModal || uiState.isInSearch) {
        uiState.updatePending = true;
        updateSSEStatus('stale');
        
        // Set a maximum defer time of 10 seconds
        if (!uiState.updateDeferTimeout) {
          uiState.updateDeferTimeout = setTimeout(() => {
            uiState.updatePending = false;
            loadMembersAndComments();
          }, 10000);
        }
        return;
      }
      
      // Clear any defer timeout
      if (uiState.updateDeferTimeout) {
        clearTimeout(uiState.updateDeferTimeout);
        uiState.updateDeferTimeout = null;
      }
      
      uiState.updatePending = false;
      updateSSEStatus('connected');
      loadMembersAndComments();
    }
    
    /**
      * Checks if a deferred update exists and applies it if the user is no longer busy.
      */
    function applyPendingUpdate() {
      if (uiState.updatePending && !uiState.isEditingComment && !uiState.isInModal) {
        console.log('User finished editing. Applying pending update now.');
        handleRealtimeUpdate();
      }
    }
    
    // Improved merge function
    function mergeServerWithLocal(serverMembers, serverComments) {
      const mergedMembers = new Map();
      const commentsMap = new Map();
      
      // Build comments map
      serverComments.forEach(comment => {
        const key = String(comment.recruitId);
        if (!commentsMap.has(key)) {
          commentsMap.set(key, []);
        }
        commentsMap.get(key).push(comment);
      });
      
      // Process server members
      serverMembers.forEach(serverMember => {
        const id = String(serverMember.id);
        const localMember = stateManager.localState.members.get(id);
        const merged = { ...serverMember };
        merged.primaryContacts = normalizePrimaryContacts(merged.primaryContacts);
        
        // Add comments from server
        merged.comments = commentsMap.get(id) || [];
        
        // Apply pending operations
        if (localMember) {
          ['tier', 'likes', 'dislikes', 'met'].forEach(field => {
            const pendingOp = stateManager.getPendingValue(id, field);
            if (pendingOp) {
              merged[field] = pendingOp.value;
            }
          });
          
          // Handle pending comments specially
          const pendingComment = stateManager.getPendingValue(id, 'comments');
          if (pendingComment && Array.isArray(pendingComment.value)) {
            // Use the pending comments array directly
            merged.comments = pendingComment.value;
          }
        }
        
        mergedMembers.set(id, merged);
      });
      
      // Add any temporary local members
      stateManager.localState.members.forEach((localMember, id) => {
        if (String(id).startsWith('temp-') && !mergedMembers.has(id)) {
          mergedMembers.set(id, localMember);
        }
      });
      
      return Array.from(mergedMembers.values());
    }
    
    document.addEventListener('focusin', function(e) {
      if (e.target.matches('.add-comment textarea')) {
        uiState.isEditingComment = true;
        uiState.activeCommentTextarea = e.target.id;
      }
    });
    
    document.addEventListener('focusout', function(e) {
      if (e.target.matches('.add-comment textarea')) {
        setTimeout(function() {
          if (document.activeElement && !document.activeElement.matches('.add-comment textarea')) {
            uiState.isEditingComment = false;
            uiState.activeCommentTextarea = null;
            applyPendingUpdate();
          }
        }, 100);
      }
    });
    
    function trackModalState(isOpen) {
      uiState.isInModal = isOpen;
      if (isOpen) {
        uiState.modalFormData = getFormData();
      } else {
        uiState.modalFormData = null;
        applyPendingUpdate();
      }
    }
    
    function getFormData() {
      var form = document.getElementById('memberForm');
      if (!form) return null;
      
      return {
        name: form.memberName.value,
        email: form.memberEmail.value,
        phone: form.memberPhone.value,
        instagram: form.memberInstagram.value,
        primaryContacts: Array.from(form.primaryContacts.selectedOptions).map(o => o.value)
      };
    }
    
    function restoreFormData(data) {
      if (!data) return;
      
      var form = document.getElementById('memberForm');
      if (!form) return;
      
      form.memberName.value = data.name || '';
      form.memberEmail.value = data.email || '';
      form.memberPhone.value = data.phone || '';
      form.memberInstagram.value = data.instagram || '';
      
      if (data.primaryContacts) {
        Array.from(form.primaryContacts.options).forEach(option => {
          option.selected = data.primaryContacts.includes(option.value);
        });
      }
    }
    
    var cancelBtn = document.getElementById("cancel-btn");
    if (cancelBtn) {
        cancelBtn.setAttribute('data-page', 'rusharchives');
        cancelBtn.href = '#';
    }
    
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        connectSSE();
      } else {
        disconnectSSE();
      }
    });
    
    window.addEventListener('beforeunload', function() {
      disconnectSSE();
    });
    
    function fireConfetti() {
      if (typeof confetti !== 'undefined') {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
      } else {
        console.warn("Confetti library not loaded.");
      }
    }
    
    function shakeGrid() {
      var grid = document.getElementById('membersGrid');
      if (grid) {
          grid.classList.add('shake');
          setTimeout(()=> grid.classList.remove('shake'), 600);
      }
    }
    
    function popComment(recruitId) {
      var commentsList = document.getElementById(`comments-list-${recruitId}`);
      if (!commentsList) return;
      var last = commentsList.querySelector('.comment:first-child');
      if (!last) return;
      last.classList.add('pop');
      setTimeout(()=> last.classList.remove('pop'), 500);
    }
    
    var tiers = {
      0: { name: 'Initial', icon: 'üë§', class: 'tier-0' },
      1: { name: 'Boat Cruise', icon: 'üö¢', class: 'tier-1' },
      2: { name: 'Steak & Lobster', icon: 'ü¶û', class: 'tier-2' },
      3: { name: 'Bid Dinner', icon: 'üéØ', class: 'tier-3' },
      4: { name: 'Bid', icon: '‚úâÔ∏è', class: 'tier-4' },
      'flushed': { name: 'Flushed', icon: 'üöΩ', class: 'tier-flushed'}
    };
    
    function showLoading() {
      var loadingOverlay = document.getElementById('loadingOverlay');
      var mainApp = document.getElementById('mainApp');
      if (loadingOverlay && mainApp) {
          loadingOverlay.style.display = 'flex';
          mainApp.classList.add('hidden');
      }
    }
    
    function hideLoading() {
      var loadingOverlay = document.getElementById('loadingOverlay');
      var mainApp = document.getElementById('mainApp');
      if (loadingOverlay && mainApp) {
          loadingOverlay.style.display = 'none';
          mainApp.classList.remove('hidden');
      }
    }
    
    function showMessage(message, type = 'error') {
      var msgElement = document.getElementById('errorMessage');
      if (msgElement) {
          msgElement.textContent = message;
          msgElement.style.display = 'block';
          if (type === 'success') {
              msgElement.style.backgroundColor = '#4CAF50';
          } else {
              msgElement.style.backgroundColor = '#f44336';
          }
          setTimeout(() => {
              msgElement.style.display = 'none';
          }, 5000);
      }
    }
    
    console.log("rushpage.html script block starting execution.");
    
    if (typeof tsParticles !== 'undefined' && document.getElementById("tsparticles")) {
        tsParticles.load("tsparticles", {
            fpsLimit: 60,
            pauseOnBlur: true,
            pauseOnOutsideViewport: true,
            background: { color: "transparent" },
            particles: {
                number: { value: 30, density: { enable: true, area: 800 } },
                shape: { type: "circle" },
                color: { value: "#FFD700" },
                opacity: { value: 0.5, random: { enable: true, minimumValue: 0.2 } },
                size: { value: { min: 1, max: 3 } },
                move: { enable: true, speed: 0.5, direction: "none", random: true, straight: false, outModes: { default: "out" } }
            },
            detectRetina: true
        });
    } else {
        console.warn("tsParticles not loaded or #tsparticles element not found.");
    }
    
    function debounce(fn, wait=300) {
      var timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), wait);
      };
    }
    
    // Performance-optimized throttle function
    function throttle(fn, limit=16) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          fn.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }
    
    // Get filtered members
    function getFilteredMembers() {
      var filteredMembers = [...members];
    
      if (searchTerm) {
        filteredMembers = filteredMembers.filter(m =>
          m.name.toLowerCase().includes(searchTerm)
        );
      }
    
      if (currentFilter !== 'all') {
        if (currentFilter === 'tier0') filteredMembers = filteredMembers.filter(m => m.tier === 0);
        else if (currentFilter === 'tier1') filteredMembers = filteredMembers.filter(m => m.tier === 1);
        else if (currentFilter === 'tier2') filteredMembers = filteredMembers.filter(m => m.tier === 2);
        else if (currentFilter === 'tier3') filteredMembers = filteredMembers.filter(m => m.tier === 3);
        else if (currentFilter === 'tier4') filteredMembers = filteredMembers.filter(m => m.tier === 4);
        else if (currentFilter === 'flushed') filteredMembers = filteredMembers.filter(m => m.tier === 'flushed');
      }
    
      filteredMembers.sort((a, b) => {
        var tierA = (a.tier === 'flushed') ? -1 : a.tier;
        var tierB = (b.tier === 'flushed') ? -1 : b.tier;
    
        if (tierA === -1 && tierB !== -1) return 1;
        if (tierB === -1 && tierA !== -1) return -1;
        if (tierA === -1 && tierB === -1) return 0;
    
        return b.tier - a.tier;
      });
    
      return filteredMembers;
    }
    
    // Improve the scroll to new member card
    function scrollToCard(cardId, highlight = true) {
      if (!cardId) return;
      
      // Clear any preserved scroll since we're intentionally scrolling
      stateManager.localState.preserveScroll = false;
      stateManager.localState.scrollPosition = 0;
      
      // Use multiple attempts to find and scroll to the card
      let attempts = 0;
      const maxAttempts = 10;
      
      function attemptScroll() {
        attempts++;
        const card = document.querySelector(`[data-member-id="${cardId}"]`);
        
        if (card) {
          // Calculate optimal scroll position
          const topBarHeight = document.querySelector('.top-bar')?.offsetHeight || 80;
          const cardRect = card.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          
          // Calculate scroll position to center the card, accounting for top bar
          const cardTop = cardRect.top + window.pageYOffset;
          const cardHeight = cardRect.height;
          const targetScroll = Math.max(0, cardTop - (viewportHeight / 2) + (cardHeight / 2) - topBarHeight);
          
          // Smooth scroll to the calculated position
          window.scrollTo({
            top: targetScroll,
            behavior: 'smooth'
          });
          
          // Add highlight animation
          if (highlight) {
            // Remove any existing highlight first
            card.classList.remove('highlight-new');
            
            // Force reflow and add highlight
            requestAnimationFrame(() => {
              card.classList.add('highlight-new');
              setTimeout(() => {
                card.classList.remove('highlight-new');
              }, 3000);
            });
          }
          
          console.log(`Successfully scrolled to card ${cardId}`);
          return true;
        } else if (attempts < maxAttempts) {
          // Card not found yet, try again
          setTimeout(attemptScroll, 100);
          return false;
        } else {
          console.warn(`Failed to find card ${cardId} after ${maxAttempts} attempts`);
          return false;
        }
      }
      
      // Start the scroll attempt process
      setTimeout(attemptScroll, 50);
    }
    
    // Virtual scrolling: Intersection Observer for lazy rendering
    var cardObserver = cardObserver || null;
    
    function initializeCardObserver() {
      // Disconnect existing observer if it exists
      if (cardObserver) {
        cardObserver.disconnect();
      }
    
      cardObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const card = entry.target;
            if (card.classList.contains('card-placeholder')) {
              // Hydrate the placeholder with actual content
              const memberId = card.dataset.memberId;
              const member = members.find(m => String(m.id) === memberId);
    
              if (member) {
                card.innerHTML = createMemberCard(member);
                card.classList.remove('card-placeholder');
                card.classList.add('card-hydrated');
    
                // Staggered entrance animation
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                requestAnimationFrame(() => {
                  card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                  card.style.opacity = '1';
                  card.style.transform = 'translateY(0)';
                });
              }
            }
          }
        });
      }, {
        rootMargin: '200px', // Start loading 200px before card enters viewport
        threshold: 0.01
      });
    }
    
    function createCardElement(member) {
      const cardElement = document.createElement('div');
      cardElement.className = 'member-card card-placeholder';
      cardElement.dataset.memberId = String(member.id);
    
      // Set data attributes for change detection
      cardElement.dataset.tier = String(member.tier);
      cardElement.dataset.likes = member.likes || '[]';
      cardElement.dataset.dislikes = member.dislikes || '[]';
      cardElement.dataset.met = member.met || '[]';
      cardElement.dataset.commentCount = String((member.comments || []).length);
    
      // Create lightweight placeholder (skeleton)
      cardElement.innerHTML = `
        <div class="skeleton-loader">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-content">
            <div class="skeleton-line skeleton-line-title"></div>
            <div class="skeleton-line skeleton-line-short"></div>
            <div class="skeleton-line skeleton-line-medium"></div>
          </div>
        </div>
      `;
    
      // Set minimum height to prevent layout shift
      cardElement.style.minHeight = '400px';
    
      // Observe this card for intersection
      if (cardObserver) {
        cardObserver.observe(cardElement);
      }
    
      return cardElement;
    }
    
    function renderMembers() {
      if (isRendering) {
        pendingRender = true;
        return;
      }
      
      isRendering = true;
      
      const grid = document.getElementById('membersGrid');
      if (!grid) {
        isRendering = false;
        return;
      }
      
      // Save state - only preserve scroll for updates, not for new additions
      const shouldPreserveScroll = !cardIdToScrollTo;
      stateManager.saveState(shouldPreserveScroll);
      
      const filteredMembers = getFilteredMembers();
      
      // Handle empty states
      if (filteredMembers.length === 0) {
        let emptyMessage = '';
        
        // Determine the appropriate empty message
        if (members.length === 0) {
          // No members exist at all
          emptyMessage = `
            <div class="empty-state">
              <h3>Welcome to ${currentRushEvent ? currentRushEvent.name : 'Rush'}</h3>
              <p>
                No recruits have been added yet. Be the first to add a potential new member!
              </p>
              <button class="btn" onclick="openAddModal()">‚ûï Add First Recruit</button>
            </div>`;
        } else if (searchTerm) {
          // Search returned no results
          emptyMessage = `
            <div class="empty-state">
              <h3>No matches found</h3>
              <p>
                No recruits match "<strong>${searchTerm}</strong>". 
                Try adjusting your search or clearing it to see all members.
              </p>
            </div>`;
        } else if (currentFilter !== 'all') {
          // Filter returned no results
          const filterNames = {
            'tier0': 'Tier 0 - Initial',
            'tier1': 'Tier 1 - Boat Cruise',
            'tier2': 'Tier 2 - Steak & Lobster',
            'tier3': 'Tier 3 - Bid Dinner',
            'tier4': 'Tier 4 - Bid',
            'flushed': 'Flushed'
          };
          emptyMessage = `
            <div class="empty-state">
              <h3>No members in ${filterNames[currentFilter] || 'this category'}</h3>
              <p>
                There are currently no recruits in this tier. 
                ${currentFilter === 'flushed' ? 'Great job keeping standards high!' : 'Check other tiers or add new members.'}
              </p>
              <button class="cancel-btn" onclick="sortMembers('all')">Show All Members</button>
            </div>`;
        }
        
        grid.innerHTML = emptyMessage;
        updateControlsStats();
        isRendering = false;
        
        // Handle any pending renders
        if (pendingRender) {
          pendingRender = false;
          setTimeout(renderMembers, 50);
        }
        
        return;
      }
      
      // Clear any empty state message if we have members to show
      const existingEmptyState = grid.querySelector('.empty-state');
      if (existingEmptyState) {
        existingEmptyState.remove();
      }
      
      const existingCards = new Map();
      
      // Build existing cards map
      grid.querySelectorAll('.member-card').forEach(card => {
        const id = card.dataset.memberId;
        if (id) existingCards.set(id, card);
      });
      
      const cardsToUpdate = [];
      const cardsToAdd = [];
      const cardsToRemove = new Set(existingCards.keys());
      
      // Process each filtered member
      filteredMembers.forEach((member, index) => {
        const memberId = String(member.id);
        const existingCard = existingCards.get(memberId);
        
        cardsToRemove.delete(memberId);
        
        if (existingCard) {
          const needsUpdate = checkCardNeedsUpdate(existingCard, member);
          if (needsUpdate) {
            cardsToUpdate.push({ element: existingCard, member, index });
          }
        } else {
          cardsToAdd.push({ member, index });
        }
      });
      
      // Use requestAnimationFrame for smooth updates
      requestAnimationFrame(() => {
        // Remove cards that are no longer needed
        cardsToRemove.forEach(cardId => {
          const card = existingCards.get(cardId);
          if (card) {
            card.style.transition = 'opacity 0.3s ease';
            card.style.opacity = '0';
            setTimeout(() => {
              if (card.parentNode) {
                card.parentNode.removeChild(card);
              }
            }, 300);
          }
        });
        
        // Update existing cards
        cardsToUpdate.forEach(({ element, member }) => {
          updateCardContent(element, member);
        });
        
        // Add new cards with proper animation
        cardsToAdd.forEach(({ member, index }) => {
          const cardElement = createCardElement(member);
          
          // Insert in the correct position
          if (index === 0 && grid.firstChild) {
            grid.insertBefore(cardElement, grid.firstChild);
          } else {
            grid.appendChild(cardElement);
          }
          
          // Animate in
          cardElement.style.opacity = '0';
          cardElement.style.transform = 'translateY(20px)';
          cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          
          requestAnimationFrame(() => {
            cardElement.style.opacity = '1';
            cardElement.style.transform = 'translateY(0)';
            cardElement.classList.add('member-card-enter');
          });
        });
        
        // Update stats
        updateControlsStats();
        
        // Restore state and handle scroll to new card
        setTimeout(() => {
          // Handle scroll to new card first (this will override preserved scroll)
          if (cardIdToScrollTo) {
            scrollToCard(cardIdToScrollTo, true);
            cardIdToScrollTo = null;
          } else if (shouldPreserveScroll) {
            // Only restore scroll if we're not scrolling to a new card
            stateManager.restoreState();
          }
          
          isRendering = false;
          
          // Process any pending render
          if (pendingRender) {
            pendingRender = false;
            setTimeout(renderMembers, 50);
          }
        }, 100);
      });
    }
    
    
    
    // Check if a card needs updating (performance optimization)
    function checkCardNeedsUpdate(cardElement, member) {
      const currentName = cardElement.querySelector('.member-info h3')?.textContent;
      const currentTier = cardElement.dataset.tier;
      const currentLikes = cardElement.dataset.likes;
      const currentDislikes = cardElement.dataset.dislikes;
      const currentMet = cardElement.dataset.met;
      const currentCommentCount = cardElement.dataset.commentCount;
      
      return (
        currentName !== member.name ||
        currentTier !== String(member.tier) ||
        currentLikes !== member.likes ||
        currentDislikes !== member.dislikes ||
        currentMet !== member.met ||
        currentCommentCount !== String((member.comments || []).length)
      );
    }
    
    // Update card content without full re-render
    function updateCardContent(cardElement, member) {
      // Save current focus state
      const activeElement = document.activeElement;
      const activeElementId = activeElement ? activeElement.id : null;
      const isCommentTextarea = activeElement && activeElement.id && activeElement.id.startsWith('comment-text-');
      
      // Only update if not actively editing this card's comment
      if (isCommentTextarea && activeElement.id === `comment-text-${member.id}`) {
        // Just update the comments list, not the textarea
        updateCardComments(member.id, member.comments || []);
      } else {
        // Full update
        cardElement.innerHTML = createMemberCard(member);
      }
      
      // Update data attributes for change detection
      cardElement.dataset.tier = String(member.tier);
      cardElement.dataset.likes = member.likes || '[]';
      cardElement.dataset.dislikes = member.dislikes || '[]';
      cardElement.dataset.met = member.met || '[]';
      cardElement.dataset.commentCount = String((member.comments || []).length);
      
      // Restore focus if needed and not editing comments
      if (activeElementId && !isCommentTextarea) {
        const newElement = document.getElementById(activeElementId);
        if (newElement) {
          newElement.focus();
        }
      }
    }
    
    // Optimized debounced render with throttling for better performance
    var debouncedRender = debounce(renderMembers, 150);
    var throttledRender = throttle(renderMembers, 100);
    
    var searchInput = document.getElementById('searchInput');
    var clearSearchBtn = document.getElementById('clearSearchBtn');
    
    if (searchInput && clearSearchBtn) {
      const debouncedSearchHandler = debounce(function(e) {
        searchTerm = e.target.value.trim().toLowerCase();
        throttledRender();
      }, 200);
    
      searchInput.addEventListener('input', (e) => {
        currentFilter = 'all'
        updateControlsStats()
        if (searchInput.value.trim().length > 0) {
          clearSearchBtn.classList.remove('hidden');
        } else {
          clearSearchBtn.classList.add('hidden');
        }
        debouncedSearchHandler(e);
      });
    
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        const event = new Event('input', { bubbles: true });
        searchInput.dispatchEvent(event);
        searchInput.focus();
      });
    }
    
    showLoading();
    
    if (!rushId) {
      onFailure(new Error('No Rush Event ID provided in URL.'));
    } else {
      fetch('/api/rush/page/' + rushId + '/details' + window.location.search)
        .then(function(r) {
          if (!r.ok) throw new Error('Failed to load rush details');
          return r.json();
        })
        .then(initializeRushPage)
        .catch(onFailure);
    }
    
    console.log("rushpage.html script block finished execution.");
    
    function initializeRushPage(rushDetails) {
      console.log("initializeRushPage called with details:", rushDetails);
      if (!rushDetails) {
        onFailure(new Error('Rush event details not found.'));
        return;
      }
      currentRushEvent = rushDetails;
    
      var rushEventHeader = document.getElementById('rushEventHeader');
      if (rushEventHeader) {
          rushEventHeader.innerHTML = '<h2>' + currentRushEvent.name + ' Dashboard</h2>';
      }
    
      // Show locked banner if rush is locked
      var lockedBanner = document.getElementById('lockedBanner');
      if (lockedBanner && isLocked) {
        lockedBanner.style.display = 'block';
      }
    
      // Initialize virtual scrolling observer
      initializeCardObserver();
    
      populatePrimaryContacts(contacts);
      loadMembersAndComments();
      connectSSE();
    
      const memberForm = document.getElementById('memberForm');
      const newMemberForm = memberForm.cloneNode(true);
      memberForm.parentNode.replaceChild(newMemberForm, memberForm);
      newMemberForm.addEventListener('submit', handleMemberFormSubmit);
    
      if (position.includes("Rho")) {
        showMessage("‚úÖ You're logged in as Rho ‚Äì full access enabled", "success");
        // Show the "All Scores" button for Rho
        var allScoresBtn = document.getElementById('allScoresBtn');
        if (allScoresBtn) {
          allScoresBtn.style.display = 'inline-block';
        }
      }
    
      // Initialize the new controls panel
      initializeControlsPanel();
      setupSwipeUpControls();
    }
    
    function loadMembersAndComments() {
      console.log("loadMembersAndComments called for rushId:", rushId);
      if (!currentRushEvent || !currentRushEvent.recruitsTabId || !currentRushEvent.commentsTabId) {
        console.error("Missing currentRushEvent details for loading members/comments.");
        onFailure(new Error("Internal error: Rush event details not fully loaded."));
        return;
      }
      
      stateManager.version++;
      const updateVersion = stateManager.version;
      
      fetch('/api/rush/page/' + rushId + '/recruits' + window.location.search)
        .then(function(r) {
          if (!r.ok) throw new Error('Failed to load recruits');
          return r.json();
        })
        .then(function(serverRecruits) {
          return fetch('/api/rush/page/' + rushId + '/comments' + window.location.search)
            .then(function(r) {
              if (!r.ok) throw new Error('Failed to load comments');
              return r.json();
            })
            .then(function(serverComments) {
              if (updateVersion === stateManager.version) {
                members = mergeServerWithLocal(serverRecruits, serverComments);
                debouncedRender();
                hideLoading();
              }
            });
        })
        .catch(onFailure);
    }
    
    function populatePrimaryContacts(contactsList) {
      console.log("Populating primary contacts with:", contactsList);
      var select = document.getElementById('primaryContacts');
      if (!select) {
          console.error("Element with ID 'primaryContacts' not found.");
          return;
      }
      select.innerHTML = '';
      contactsList.forEach(contact => {
        var option = document.createElement('option');
        option.value = contact;
        option.textContent = contact;
        select.appendChild(option);
      });
    }
    
    function onFailure(error) {
      hideLoading();
      showMessage(`Error: ${error.message || error}`);
      console.error('Apps Script Error:', error);
    }
    // Fixed search input handler
    function setupSearchHandlers() {
      var searchInput = document.getElementById('searchInput');
      var clearSearchBtn = document.getElementById('clearSearchBtn');
    
      searchInput.addEventListener('focus', () => { uiState.isInSearch = true; });
      searchInput.addEventListener('blur',  () => {
        uiState.isInSearch = false;
        applyPendingUpdate(); // like you do for comments/modal
      });
    
      if (searchInput && clearSearchBtn) {
        const debouncedSearchHandler = debounce(function(e) {
          searchTerm = e.target.value.trim().toLowerCase();
          currentFilter = 'all'; // Reset filter when searching
          
          // Clear any pending scroll to new card since we're searching
          cardIdToScrollTo = null;
          
          updateControlsStats();
          throttledRender();
        }, 200);
    
        searchInput.addEventListener('input', (e) => {
          if (searchInput.value.trim().length > 0) {
            clearSearchBtn.classList.remove('hidden');
          } else {
            clearSearchBtn.classList.add('hidden');
          }
          debouncedSearchHandler(e);
        });
    
        clearSearchBtn.addEventListener('click', () => {
          searchInput.value = '';
          searchTerm = '';
          clearSearchBtn.classList.add('hidden');
          cardIdToScrollTo = null; // Clear any pending scroll
          throttledRender();
          searchInput.focus();
        });
      }
    }
    
    // Initialize search handlers
    setupSearchHandlers()
    
    // ===== LEADERBOARD FUNCTIONS =====
    
    function showLeaderboardOnRushPage() {
      var modal = document.getElementById('leaderboardModal');
      var content = document.getElementById('leaderboardContent');
      var subtitle = document.getElementById('leaderboardSubtitle');
    
      // Show modal with spinner
      modal.style.display = 'flex';
      content.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';
    
      // Set subtitle to current rush name
      subtitle.textContent = 'Loading...';

      // Call backend to get leaderboard data
      fetch('/api/rush/events/' + rushId + '/engagement' + window.location.search)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.error) {
            content.innerHTML = '<div class="no-data-message">Error loading leaderboard: ' + data.error + '</div>';
            return;
          }
          subtitle.textContent = data.rushName || '';
          renderCombinedLeaderboard(data);
        })
        .catch(function(err) {
          console.error('Error loading leaderboard:', err);
          content.innerHTML = '<div class="no-data-message">Error loading leaderboard. Please try again.</div>';
        });
    }

    // Helper to generate HTML for a single comment
function renderCommentHtml(c, memberId, isTemp) {
  var isAuthor = c.author === currentUser;
  var isRho = position.includes("Rho");
  
  // Actions: Edit (Author only), Delete (Rho or Author)
  var actions = [];
  
  if (isAuthor) {
      actions.push(`<button class="comment-action-btn" onclick="editComment('${memberId}')" ${isTemp?'disabled':''} title="Edit">‚úèÔ∏è</button>`);
  }
  
  if (isRho || isAuthor) {
      // Safe escape for the author name in the onclick handler
      var safeAuthor = c.author.replace(/'/g, "\\'");
      actions.push(`<button class="comment-action-btn delete-btn" onclick="deleteComment('${memberId}', '${safeAuthor}')" ${isTemp?'disabled':''} title="Delete">üóëÔ∏è</button>`);
  }

  var actionsHtml = actions.length ? `<div class="comment-actions">${actions.join('')}</div>` : '';

  return `
  <div class="comment">
      <div class="comment-author">${c.author}</div>
      <div class="comment-meta">${formatCommentTime(getCommentTimestamp(c))}</div>
      <div class="comment-text">${c.text}</div>
      ${actionsHtml}
  </div>`;
}
    
    function renderCombinedLeaderboard(data) {
      var content = document.getElementById('leaderboardContent');
    
      if (!data.topRushers || data.topRushers.length === 0) {
        content.innerHTML = '<div class="no-data-message">No engagement data yet for this rush event.</div>';
        return;
      }
    
      var html = '';
      var allRushers = data.allRushers || [];
    
      // Find current user's stats
      var myStats = allRushers.find(function(rusher) {
        return rusher.name === currentUser;
      });
    
      var myRank = myStats ? allRushers.findIndex(function(rusher) {
        return rusher.name === currentUser;
      }) + 1 : null;
    
      // 1. PERSONAL STATS SECTION (at top)
      if (myStats) {
        var rankEmoji = myRank === 1 ? 'ü•á' : myRank === 2 ? 'ü•à' : myRank === 3 ? 'ü•â' : '';
    
        html += '<div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">';
        html += '  <h3 style="color: var(--primary-gold); margin: 0 0 1rem 0; text-align: center; font-size: 1.3rem;">Your Performance</h3>';
        html += '  <div style="text-align: center; margin-bottom: 1rem;">';
        html += '    <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">' + (rankEmoji || 'üèÖ') + '</div>';
        html += '    <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-gold);">Rank #' + myRank + ' of ' + data.totalParticipants + '</div>';
        html += '    <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary); margin-top: 0.5rem;">' + myStats.points + ' Points</div>';
        html += '  </div>';
    
        // Mini stats grid
        html += '  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">';
        html += '    <div style="text-align: center; padding: 0.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-gold);">' + myStats.recruitsMetCount + '</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Met</div>';
        html += '    </div>';
        html += '    <div style="text-align: center; padding: 0.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-gold);">' + myStats.commentsCount + '</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Comments</div>';
        html += '    </div>';
        html += '    <div style="text-align: center; padding: 0.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-gold);">' + (myStats.bidSuccessBonus / 50) + '</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Bids</div>';
        html += '    </div>';
        html += '  </div>';
    
        // Badges
        if (myStats.badges && myStats.badges.length > 0) {
          html += '  <div style="border-top: 1px solid rgba(255, 215, 0, 0.2); padding-top: 1rem;">';
          html += '    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-align: center;">Your Badges</div>';
          html += '    <div class="badges-container" style="justify-content: center; gap: 0.5rem; flex-wrap: wrap;">';
          myStats.badges.forEach(function(badge) {
            html += '      <span class="badge" onclick="showBadgeInfo(\'' + escapeJs(badge.name) + '\', \'' + escapeJs(badge.description) + '\', \'' + badge.emoji + '\', event)" title="Click for details" style="font-size: 0.8rem; padding: 0.35rem 0.75rem;">';
            html += '        <span class="badge-emoji">' + badge.emoji + '</span>';
            html += '        <span>' + escapeHtml(badge.name) + '</span>';
            html += '      </span>';
          });
          html += '    </div>';
          html += '  </div>';
        }
    
        html += '</div>';
      } else {
        // No participation yet - show encouraging message
        html += '<div style="background: linear-gradient(135deg, rgba(100, 100, 100, 0.15), rgba(100, 100, 100, 0.05)); border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; text-align: center;">';
        html += '  <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>';
        html += '  <h3 style="color: var(--text-secondary); margin: 0 0 1rem 0; font-size: 1.3rem;">No Participation Yet</h3>';
        html += '  <p style="color: var(--text-secondary); margin: 0 0 1.5rem 0; line-height: 1.6;">You haven\'t engaged with this rush event yet.<br>Start by meeting recruits, leaving thoughtful comments, and voting!</p>';
        html += '  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; max-width: 400px; margin: 0 auto;">';
        html += '    <div style="text-align: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üëã</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Meet Recruits</div>';
        html += '    </div>';
        html += '    <div style="text-align: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üí¨</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Leave Comments</div>';
        html += '    </div>';
        html += '    <div style="text-align: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
        html += '      <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üëç</div>';
        html += '      <div style="font-size: 0.75rem; color: var(--text-secondary);">Vote on Recruits</div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      }
    
      // 2. TOP 10 LEADERBOARD SECTION
      html += '<h3 style="color: var(--primary-gold); margin: 0 0 1rem 0; text-align: center; font-size: 1.3rem;">Top 10 Contributors</h3>';
    
      // Summary stats
      html += '<div class="leaderboard-stats">';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.totalParticipants + '</span>';
      html += '    <span class="leaderboard-stat-label">Brothers Participated</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.avgPoints + '</span>';
      html += '    <span class="leaderboard-stat-label">Avg Points</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.topRushers.length + '</span>';
      html += '    <span class="leaderboard-stat-label">Top Contributors</span>';
      html += '  </div>';
      html += '</div>';
    
      // Leaderboard list
      html += '<div class="leaderboard-list">';
    
      data.topRushers.forEach(function(rusher, index) {
        var rank = index + 1;
        var rankClass = 'rank-' + rank;
        var rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
        var isCurrentUser = rusher.name === currentUser;
    
        html += '<div class="leaderboard-item ' + (rank <= 3 ? rankClass : '') + (isCurrentUser ? ' ' : '') + '" style="' + (isCurrentUser ? 'border: 2px solid var(--primary-gold); background: rgba(255, 215, 0, 0.05);' : '') + '">';
        html += '  <div class="leaderboard-rank">' + (rankEmoji || rank) + '</div>';
        html += '  <div class="leaderboard-info">';
        html += '    <div class="leaderboard-name">' + rusher.name + (isCurrentUser ? ' <span style="color: var(--primary-gold);">(You)</span>' : '') + '</div>';
        html += '    <div class="leaderboard-details">';
        html += '      <span>Met: ' + rusher.recruitsMetCount + '</span>';
        html += '      <span>Likes: ' + rusher.recruitsLikedCount + '</span>';
        html += '      <span>Comments: ' + rusher.commentsCount + '</span>';
        if (rusher.bidSuccessBonus > 0) {
          html += '      <span>Successful Bids: ' + (rusher.bidSuccessBonus / 50) + '</span>';
        }
        html += '    </div>';
    
        // Badges
        if (rusher.badges && rusher.badges.length > 0) {
          html += '    <div class="badges-container">';
          rusher.badges.forEach(function(badge) {
            html += '      <span class="badge" onclick="showBadgeInfo(\'' + escapeJs(badge.name) + '\', \'' + escapeJs(badge.description) + '\', \'' + badge.emoji + '\', event)" title="Click for details">';
            html += '        <span class="badge-emoji">' + badge.emoji + '</span>';
            html += '        <span>' + escapeHtml(badge.name) + '</span>';
            html += '      </span>';
          });
          html += '    </div>';
        }
    
        html += '  </div>';
        html += '  <div class="leaderboard-points">' + rusher.points + '</div>';
        html += '</div>';
      });
    
      html += '</div>';
    
      // 3. POINT CALCULATION GUIDE (collapsible)
      html += '<div style="margin-top: 2rem; border-top: 2px solid rgba(255, 215, 0, 0.2); padding-top: 2rem;">';
      html += '  <div onclick="togglePointGuide()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255, 215, 0, 0.05); border-radius: 8px; user-select: none;">';
      html += '    <div style="display: flex; align-items: center; gap: 0.75rem;">';
      html += '      <span style="font-size: 1.5rem;">üìñ</span>';
      html += '      <span style="font-weight: 600; color: var(--primary-gold);">How Points Are Calculated</span>';
      html += '    </div>';
      html += '    <span id="pointGuideArrow" style="font-size: 1.2rem; color: var(--text-secondary); transition: transform 0.3s;">‚ñº</span>';
      html += '  </div>';
      html += '  <div id="pointGuideContent" style="display: none; margin-top: 1rem; padding: 1.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px; line-height: 1.8;">';
      html += '    <div style="margin-bottom: 1.5rem;">';
      html += '      <h4 style="color: var(--primary-gold); margin: 0 0 0.75rem 0; font-size: 1rem;">Basic Actions</h4>';
      html += '      <div style="color: var(--text-secondary); font-size: 0.9rem;">';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Met a recruit:</strong> +6 points</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Left a comment:</strong> +5 points base</div>';
      html += '        <div style="margin-bottom: 0.5rem; padding-left: 1.5rem;">‚Üí Long comment (50+ chars): +5 bonus</div>';
      html += '        <div style="margin-bottom: 0.5rem; padding-left: 1.5rem;">‚Üí Very long comment (100+ chars): +10 bonus</div>';
      html += '      </div>';
      html += '    </div>';
      html += '    <div style="margin-bottom: 1.5rem;">';
      html += '      <h4 style="color: var(--primary-gold); margin: 0 0 0.75rem 0; font-size: 1rem;">Voting System</h4>';
      html += '      <div style="color: var(--text-secondary); font-size: 0.9rem;">';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Like (after meeting):</strong> +2 points</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: #4CAF50;">Like with comment:</strong> +5 points</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: #ff6b6b;">Like without meeting:</strong> 0 points (no blind votes!)</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Dislike:</strong> +5 points (honest feedback valued!)</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: #4CAF50;">Dislike with comment:</strong> +8 points</div>';
      html += '      </div>';
      html += '    </div>';
      html += '    <div style="margin-bottom: 1.5rem;">';
      html += '      <h4 style="color: var(--primary-gold); margin: 0 0 0.75rem 0; font-size: 1rem;">Leadership & Initiative</h4>';
      html += '      <div style="color: var(--text-secondary); font-size: 0.9rem;">';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Primary contact:</strong> +50 points per recruit</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">First to meet:</strong> +10 points üê¶</div>';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">First to like:</strong> +8 points ‚ö°</div>';
      html += '      </div>';
      html += '    </div>';
      html += '    <div style="margin-bottom: 1.5rem;">';
      html += '      <h4 style="color: var(--primary-gold); margin: 0 0 0.75rem 0; font-size: 1rem;">Success Bonus</h4>';
      html += '      <div style="color: var(--text-secondary); font-size: 0.9rem;">';
      html += '        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong style="color: var(--text-primary);">Primary contact for a recruit who got a bid:</strong> +50 points üéØ</div>';
      html += '        <div style="font-size: 0.85rem; font-style: italic; margin-top: 0.5rem; color: var(--text-secondary);">Rewards brothers who build relationships that lead to successful bids!</div>';
      html += '      </div>';
      html += '    </div>';
      html += '    <div>';
      html += '      <h4 style="color: var(--primary-gold); margin: 0 0 0.75rem 0; font-size: 1rem;">üåü Quality Multiplier</h4>';
      html += '      <div style="color: var(--text-secondary); font-size: 0.9rem;">';
      html += '        <div style="margin-bottom: 0.5rem;">Your final score is multiplied based on engagement quality:</div>';
      html += '        <div style="margin-bottom: 0.5rem; padding-left: 1rem;">‚Ä¢ <strong style="color: var(--text-primary);">50%+ comment rate:</strong> 1.2x multiplier (+20% bonus)</div>';
      html += '        <div style="margin-bottom: 0.5rem; padding-left: 1rem;">‚Ä¢ <strong style="color: #4CAF50;">75%+ comment rate:</strong> 1.5x multiplier (+50% bonus) üî•</div>';
      html += '        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(76, 175, 80, 0.15); border-left: 3px solid #4CAF50; border-radius: 4px; font-size: 0.85rem;">';
      html += '          üí° <strong>Pro Strategy:</strong> Comment on most of your votes to earn massive bonus points! Quality beats quantity.';
      html += '        </div>';
      html += '      </div>';
      html += '    </div>';
      html += '  </div>';
      html += '</div>';
    
      content.innerHTML = html;
    }
    
    function renderLeaderboardOnRushPage(data) {
      var content = document.getElementById('leaderboardContent');
    
      if (!data.topRushers || data.topRushers.length === 0) {
        content.innerHTML = '<div class="no-data-message">No engagement data yet for this rush event.</div>';
        return;
      }
    
      // Build the HTML
      var html = '';
    
      // Summary stats
      html += '<div class="leaderboard-stats">';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.totalParticipants + '</span>';
      html += '    <span class="leaderboard-stat-label">Brothers Participated</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.avgPoints + '</span>';
      html += '    <span class="leaderboard-stat-label">Avg Points</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.topRushers.length + '</span>';
      html += '    <span class="leaderboard-stat-label">Top Contributors</span>';
      html += '  </div>';
      html += '</div>';
    
      // Leaderboard list
      html += '<div class="leaderboard-list">';
    
      data.topRushers.forEach(function(rusher, index) {
        var rank = index + 1;
        var rankClass = 'rank-' + rank;
        var rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
    
        html += '<div class="leaderboard-item ' + (rank <= 3 ? rankClass : '') + '">';
        html += '  <div class="leaderboard-rank">' + (rankEmoji || rank) + '</div>';
        html += '  <div class="leaderboard-info">';
        html += '    <div class="leaderboard-name">' + rusher.name + '</div>';
        html += '    <div class="leaderboard-details">';
        html += '      <span>Met: ' + rusher.recruitsMetCount + '</span>';
        html += '      <span>Likes: ' + rusher.recruitsLikedCount + '</span>';
        html += '      <span>Comments: ' + rusher.commentsCount + '</span>';
        if (rusher.bidSuccessBonus > 0) {
          html += '      <span>Successful Bids: ' + (rusher.bidSuccessBonus / 50) + '</span>';
        }
        html += '    </div>';
    
        // Badges
        if (rusher.badges && rusher.badges.length > 0) {
          html += '    <div class="badges-container">';
          rusher.badges.forEach(function(badge) {
            html += '      <span class="badge" onclick="showBadgeInfo(\'' + escapeJs(badge.name) + '\', \'' + escapeJs(badge.description) + '\', \'' + badge.emoji + '\', event)" title="Click for details">';
            html += '        <span class="badge-emoji">' + badge.emoji + '</span>';
            html += '        <span>' + escapeHtml(badge.name) + '</span>';
            html += '      </span>';
          });
          html += '    </div>';
        }
    
        html += '  </div>';
        html += '  <div class="leaderboard-points">' + rusher.points + '</div>';
        html += '</div>';
      });
    
      html += '</div>';
    
      content.innerHTML = html;
    }
    
    function renderPersonalStats(data) {
      var content = document.getElementById('leaderboardContent');
    
      // Find current user's stats from ALL rushers (not just top 10)
      var allRushers = data.allRushers || [];
      var myStats = allRushers.find(function(rusher) {
        return rusher.name === currentUser;
      });
    
      if (!myStats) {
        content.innerHTML = '<div class="no-data-message">You haven\'t participated in this rush event yet. Start by meeting recruits, liking/disliking them, and leaving thoughtful comments!</div>';
        return;
      }
    
      // Calculate rank
      var myRank = allRushers.findIndex(function(rusher) {
        return rusher.name === currentUser;
      }) + 1;
    
      var rankEmoji = myRank === 1 ? 'ü•á' : myRank === 2 ? 'ü•à' : myRank === 3 ? 'ü•â' : '';
    
      // Build personal stats view
      var html = '';
    
      // Header with rank
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '  <div style="font-size: 3rem; margin-bottom: 0.5rem;">' + (rankEmoji || 'üèÖ') + '</div>';
      html += '  <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary-gold); margin-bottom: 0.5rem;">Your Rank: #' + myRank + ' of ' + data.totalParticipants + '</div>';
      html += '  <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">' + myStats.points + ' Points</div>';
      html += '</div>';
    
      // Stats grid
      html += '<div class="leaderboard-stats" style="margin-bottom: 2rem;">';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + myStats.recruitsMetCount + '</span>';
      html += '    <span class="leaderboard-stat-label">Recruits Met</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + myStats.recruitsLikedCount + '</span>';
      html += '    <span class="leaderboard-stat-label">Likes</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + myStats.recruitsDislikedCount + '</span>';
      html += '    <span class="leaderboard-stat-label">Dislikes</span>';
      html += '  </div>';
      html += '</div>';
    
      html += '<div class="leaderboard-stats" style="margin-bottom: 2rem;">';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + myStats.commentsCount + '</span>';
      html += '    <span class="leaderboard-stat-label">Comments</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + (myStats.bidSuccessBonus / 50) + '</span>';
      html += '    <span class="leaderboard-stat-label">Successful Bids</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.avgPoints + '</span>';
      html += '    <span class="leaderboard-stat-label">Average Points</span>';
      html += '  </div>';
      html += '</div>';
    
      // Badges
      if (myStats.badges && myStats.badges.length > 0) {
        html += '<div style="margin-bottom: 2rem;">';
        html += '  <h3 style="color: var(--primary-gold); margin-bottom: 1rem; text-align: center;">Your Badges</h3>';
        html += '  <div class="badges-container" style="justify-content: center; gap: 0.75rem;">';
        myStats.badges.forEach(function(badge) {
          html += '    <span class="badge" onclick="showBadgeInfo(\'' + escapeJs(badge.name) + '\', \'' + escapeJs(badge.description) + '\', \'' + badge.emoji + '\', event)" title="Click for details" style="font-size: 0.9rem; padding: 0.5rem 1rem;">';
          html += '      <span class="badge-emoji" style="font-size: 1.5rem;">' + badge.emoji + '</span>';
          html += '      <span>' + escapeHtml(badge.name) + '</span>';
          html += '    </span>';
        });
        html += '  </div>';
        html += '</div>';
      } else {
        html += '<div style="text-align: center; margin: 2rem 0; color: var(--text-secondary);">';
        html += '  <p>No badges earned yet. Keep engaging to unlock badges!</p>';
        html += '</div>';
      }
    
      // Performance indicator
      var performanceText = '';
      var performanceColor = '';
      if (myStats.points >= data.avgPoints * 1.5) {
        performanceText = 'Excellent! You\'re well above average.';
        performanceColor = 'var(--success-green)';
      } else if (myStats.points >= data.avgPoints) {
        performanceText = 'Great job! You\'re above average.';
        performanceColor = 'var(--primary-gold)';
      } else if (myStats.points >= data.avgPoints * 0.5) {
        performanceText = 'Good effort! Keep engaging to improve.';
        performanceColor = 'var(--text-secondary)';
      } else {
        performanceText = 'More engagement needed. Try meeting more recruits and leaving thoughtful comments!';
        performanceColor = 'var(--text-secondary)';
      }
    
      html += '<div style="text-align: center; padding: 1rem; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 8px; margin-top: 2rem;">';
      html += '  <div style="color: ' + performanceColor + '; font-weight: 500;">' + performanceText + '</div>';
      html += '</div>';
    
      content.innerHTML = html;
    }
    
    function closeLeaderboardOnRushPage() {
      document.getElementById('leaderboardModal').style.display = 'none';
    }
    
    // Toggle point calculation guide
    function togglePointGuide() {
      var content = document.getElementById('pointGuideContent');
      var arrow = document.getElementById('pointGuideArrow');
    
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      }
    }
    
    // Show all scores for Rho
    function showAllScores() {
      var modal = document.getElementById('leaderboardModal');
      var content = document.getElementById('leaderboardContent');
      var subtitle = document.getElementById('leaderboardSubtitle');
    
      // Show modal with spinner
      modal.style.display = 'flex';
      content.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';
    
      // Set subtitle
      subtitle.textContent = 'Loading all scores...';

      // Call backend to get leaderboard data
      fetch('/api/rush/events/' + rushId + '/engagement' + window.location.search)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.error) {
            content.innerHTML = '<div class="no-data-message">Error loading scores: ' + data.error + '</div>';
            return;
          }
          subtitle.textContent = data.rushName + ' - All Brother Scores';
          renderAllScores(data);
        })
        .catch(function(err) {
          console.error('Error loading all scores:', err);
          content.innerHTML = '<div class="no-data-message">Error loading scores. Please try again.</div>';
        });
    }
    
    // Render all scores (for Rho view)
    function renderAllScores(data) {
      var content = document.getElementById('leaderboardContent');
      var allRushers = data.allRushers || [];
    
      if (allRushers.length === 0) {
        content.innerHTML = '<div class="no-data-message">No engagement data yet for this rush event.</div>';
        return;
      }
    
      var html = '';
    
      // Summary stats
      html += '<div class="leaderboard-stats">';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + allRushers.length + '</span>';
      html += '    <span class="leaderboard-stat-label">Total Brothers</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      html += '    <span class="leaderboard-stat-value">' + data.avgPoints + '</span>';
      html += '    <span class="leaderboard-stat-label">Avg Points</span>';
      html += '  </div>';
      html += '  <div class="leaderboard-stat">';
      var totalPoints = allRushers.reduce(function(sum, r) { return sum + r.points; }, 0);
      html += '    <span class="leaderboard-stat-value">' + totalPoints + '</span>';
      html += '    <span class="leaderboard-stat-label">Total Points</span>';
      html += '  </div>';
      html += '</div>';
    
      // Filter/sort options with mobile-friendly layout
      html += '<div class="all-scores-controls" style="margin: 1.5rem 0; padding: 1rem; background: rgba(255, 215, 0, 0.05); border-radius: 8px;">';
      html += '  <style>';
      html += '    @media (max-width: 768px) {';
      html += '      .all-scores-controls-inner { flex-direction: column !important; align-items: stretch !important; }';
      html += '      .all-scores-controls-inner label { margin-bottom: 0.5rem; }';
      html += '      .all-scores-controls-inner select, .all-scores-controls-inner input { width: 100% !important; max-width: none !important; }';
      html += '    }';
      html += '  </style>';
      html += '  <div class="all-scores-controls-inner" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">';
      html += '    <label style="color: var(--text-secondary); white-space: nowrap;">Sort by:</label>';
      html += '    <select id="sortSelect" onchange="sortAllScores()" style="padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; min-width: 150px;">';
      html += '      <option value="points">Points (High to Low)</option>';
      html += '      <option value="name">Name (A-Z)</option>';
      html += '      <option value="met">Recruits Met</option>';
      html += '      <option value="comments">Comments Made</option>';
      html += '    </select>';
      html += '    <input type="text" id="filterName" placeholder="Filter by name..." onkeyup="filterAllScores()" style="padding: 0.5rem; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; flex: 1; min-width: 150px; max-width: 300px;">';
      html += '  </div>';
      html += '</div>';
    
      // Add mobile-friendly styles for the list
      html += '<style>';
      html += '  @media (max-width: 768px) {';
      html += '    #allScoresList { max-height: 400px !important; }';
      html += '    .all-scores-item { flex-direction: column !important; align-items: flex-start !important; gap: 0.75rem !important; }';
      html += '    .all-scores-rank { min-width: auto !important; }';
      html += '    .all-scores-info { width: 100% !important; }';
      html += '    .all-scores-details { flex-direction: column !important; gap: 0.3rem !important; }';
      html += '    .all-scores-points { align-self: flex-end !important; font-size: 1.25rem !important; }';
      html += '  }';
      html += '</style>';
    
      // All rushers list with scrollable container
      html += '<div class="leaderboard-list" id="allScoresList" style="max-height: 500px; overflow-y: auto;">';
    
      allRushers.forEach(function(rusher, index) {
        var rank = index + 1;
        var rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
        var rankClass = rank <= 3 ? 'rank-' + rank : '';
    
        html += '<div class="leaderboard-item all-scores-item ' + rankClass + '" data-name="' + rusher.name.toLowerCase() + '" data-points="' + rusher.points + '" data-met="' + rusher.recruitsMetCount + '" data-comments="' + rusher.commentsCount + '" style="display: flex; align-items: center; gap: 1rem; padding: 1rem;">';
        html += '  <div class="leaderboard-rank all-scores-rank" style="min-width: 50px; text-align: center;">' + (rankEmoji || rank) + '</div>';
        html += '  <div class="leaderboard-info all-scores-info" style="flex: 1; min-width: 0;">';
        html += '    <div class="leaderboard-name" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">' + rusher.name + '</div>';
        html += '    <div class="leaderboard-details all-scores-details" style="display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.85rem;">';
        html += '      <span>Met: ' + rusher.recruitsMetCount + '</span>';
        html += '      <span>Likes: ' + rusher.recruitsLikedCount + '</span>';
        html += '      <span>Dislikes: ' + rusher.recruitsDislikedCount + '</span>';
        html += '      <span>Comments: ' + rusher.commentsCount + '</span>';
        if (rusher.primaryContactCount > 0) {
          html += '      <span>Primary: ' + rusher.primaryContactCount + '</span>';
        }
        if (rusher.firstToMeetCount > 0) {
          html += '      <span>First Meets: ' + rusher.firstToMeetCount + '</span>';
        }
        html += '    </div>';
    
        // Badges
        if (rusher.badges && rusher.badges.length > 0) {
          html += '    <div class="badges-container">';
          rusher.badges.forEach(function(badge) {
            html += '      <span class="badge" onclick="showBadgeInfo(\'' + escapeJs(badge.name) + '\', \'' + escapeJs(badge.description) + '\', \'' + badge.emoji + '\', event)" title="Click for details">';
            html += '        <span class="badge-emoji">' + badge.emoji + '</span>';
            html += '        <span>' + escapeHtml(badge.name) + '</span>';
            html += '      </span>';
          });
          html += '    </div>';
        }
    
        html += '  </div>';
        html += '  <div class="leaderboard-points all-scores-points" style="min-width: 80px; text-align: right; font-size: 1.5rem; font-weight: 700; color: var(--gold);">' + rusher.points + '</div>';
        html += '</div>';
      });
    
      html += '</div>';
    
      // Store data for sorting/filtering
      window.allScoresData = allRushers;
    
      content.innerHTML = html;
    }
    
    // Sort all scores list
    function sortAllScores() {
      var sortBy = document.getElementById('sortSelect').value;
      var list = document.getElementById('allScoresList');
      var items = Array.from(list.getElementsByClassName('leaderboard-item'));
    
      items.sort(function(a, b) {
        switch(sortBy) {
          case 'points':
            return parseInt(b.dataset.points) - parseInt(a.dataset.points);
          case 'name':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'met':
            return parseInt(b.dataset.met) - parseInt(a.dataset.met);
          case 'comments':
            return parseInt(b.dataset.comments) - parseInt(a.dataset.comments);
          default:
            return 0;
        }
      });
    
      // Clear and re-append sorted items
      list.innerHTML = '';
      items.forEach(function(item, index) {
        // Update rank display
        var rankDiv = item.querySelector('.leaderboard-rank');
        if (sortBy === 'points') {
          var rank = index + 1;
          var rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
          rankDiv.textContent = rankEmoji || rank;
        } else {
          rankDiv.textContent = '-';
        }
        list.appendChild(item);
      });
    }
    
    // Filter all scores list
    function filterAllScores() {
      var filter = document.getElementById('filterName').value.toLowerCase();
      var items = document.getElementsByClassName('leaderboard-item');
    
      Array.from(items).forEach(function(item) {
        var name = item.dataset.name;
        if (name.includes(filter)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // Helper function to escape HTML for security
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Helper function to escape strings for JavaScript
    function escapeJs(text) {
      if (!text) return '';
      return text.replace(/\\/g, '\\\\')
                 .replace(/'/g, "\\'")
                 .replace(/"/g, '\\"')
                 .replace(/\n/g, '\\n')
                 .replace(/\r/g, '\\r');
    }
    
    // Badge info tooltip
    function showBadgeInfo(name, description, emoji, event) {
      var tooltip = document.getElementById('badgeTooltip');
      var tooltipEmoji = document.getElementById('badgeTooltipEmoji');
      var tooltipName = document.getElementById('badgeTooltipName');
      var tooltipDescription = document.getElementById('badgeTooltipDescription');
    
      // Set content
      tooltipEmoji.textContent = emoji;
      tooltipName.textContent = name;
      tooltipDescription.textContent = description;
    
      // Position tooltip near the badge
      var rect = event.currentTarget.getBoundingClientRect();
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.bottom + 10) + 'px';
    
      // Show tooltip
      tooltip.classList.add('show');
    
      // Hide tooltip after 3 seconds
      setTimeout(function() {
        tooltip.classList.remove('show');
      }, 3000);
    }
    
    // Hide tooltip when clicking anywhere
    document.addEventListener('click', function(e) {
      var tooltip = document.getElementById('badgeTooltip');
      if (tooltip && !e.target.closest('.badge')) {
        tooltip.classList.remove('show');
      }
    });
    
    // Close leaderboard modal when clicking outside
    document.getElementById('leaderboardModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLeaderboardOnRushPage();
      }
    });
    
    
    </script>
    </body>
    </html>
<script>
  // Initialize the admin menu once the rush page content is loaded.
  // Use a timeout to ensure all elements are available in the DOM.
  setTimeout(initAdminMenu, 100);
</script>

